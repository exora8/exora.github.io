<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Call (Simple & Meriah)</title>
    <style>
        /* --- [REVISI TOTAL] CSS Simple & Meriah --- */

        /* Import Font (Opsional, tapi bagus) */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        /* --- Keyframes Animasi Meriah --- */
        @keyframes backgroundPulse {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes buttonIdleGlow {
            0% { box-shadow: 0 0 8px rgba(0, 255, 255, 0.6), 0 0 15px rgba(0, 255, 255, 0.4); }
            50% { box-shadow: 0 0 15px rgba(0, 255, 255, 0.8), 0 0 25px rgba(0, 255, 255, 0.6); }
            100% { box-shadow: 0 0 8px rgba(0, 255, 255, 0.6), 0 0 15px rgba(0, 255, 255, 0.4); }
        }

        @keyframes buttonListeningPulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 0, 100, 0.7), 0 0 20px rgba(255, 0, 100, 0.5), 0 0 35px rgba(255, 0, 100, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 0, 100, 1), 0 0 35px rgba(255, 0, 100, 0.7), 0 0 50px rgba(255, 0, 100, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 0, 100, 0.7), 0 0 20px rgba(255, 0, 100, 0.5), 0 0 35px rgba(255, 0, 100, 0.3); }
        }

         @keyframes buttonSpeakingWave {
             0% { background-position: 0% 50%; box-shadow: 0 0 12px rgba(150, 0, 255, 0.7), 0 0 25px rgba(150, 0, 255, 0.5); }
             50% { background-position: 100% 50%; box-shadow: 0 0 18px rgba(150, 0, 255, 0.9), 0 0 35px rgba(150, 0, 255, 0.7); }
             100% { background-position: 0% 50%; box-shadow: 0 0 12px rgba(150, 0, 255, 0.7), 0 0 25px rgba(150, 0, 255, 0.5); }
         }

        @keyframes thinkingShimmerSimple {
            0% { background-color: #555; }
            50% { background-color: #888; }
            100% { background-color: #555; }
        }

        @keyframes transcriptEntry {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes statusPulse {
             0% { transform: scale(1); opacity: 0.8; }
             50% { transform: scale(1.03); opacity: 1; }
             100% { transform: scale(1); opacity: 0.8; }
        }

        /* --- Base Style --- */
        body {
            font-family: 'Poppins', sans-serif;
            /* Background Animasi Meriah */
            background: linear-gradient(135deg, #1a001a, #001a1a, #1a1a00, #1a0000);
            background-size: 400% 400%;
            animation: backgroundPulse 15s ease infinite;
            color: #f0f0f0; /* Teks putih terang */
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 30px 15px;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
        }

        /* --- Judul & Header --- */
        h1 {
            color: #00ffff; /* Cyan terang */
            font-weight: 600;
            margin-bottom: 5px;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.7), 0 0 10px rgba(0, 255, 255, 0.5);
            text-align: center;
        }

        body > p:first-of-type { /* Subjudul */
            font-size: 0.9em;
            color: #aaa;
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
        }

        /* --- Peringatan (Tetap simpel) --- */
        .warning {
            background-color: rgba(255, 255, 0, 0.1);
            color: #ffff00; /* Kuning terang */
            border: 1px solid rgba(255, 255, 0, 0.5);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 25px;
            max-width: 500px;
            width: 95%;
            text-align: center;
            font-size: 0.85em;
        }

        /* --- Kontainer Utama (Hilangkan visual box, hanya untuk grouping) --- */
        .container {
            background: none; /* Hapus background */
            padding: 0; /* Hapus padding container */
            border-radius: 0;
            box-shadow: none; /* Hapus shadow */
            max-width: 600px;
            width: 100%;
            box-sizing: border-box;
            border: none; /* Hapus border */
        }

        /* --- Status Box (Simplifikasi) --- */
        .status-box {
            text-align: center;
            margin-bottom: 20px;
            padding: 5px;
            background: none; /* Hapus background */
            border: none; /* Hapus border */
        }

        .status-box strong {
            color: #bbb;
            font-weight: 400;
            font-size: 0.9em;
        }

        #status {
            font-weight: 600;
            color: #00ffcc; /* Warna status cerah */
            display: inline-block; /* Agar animasi transform bekerja */
             transition: color 0.3s ease;
             /* Animasi pulse halus saat status berubah (jika tidak idle) */
             /* (JS tidak trigger class khusus, jadi ini apply terus kecuali Idle) */
             /* Jika mau lebih spesifik, butuh modif JS */
             animation: statusPulse 2s infinite ease-in-out;
        }
         /* Hentikan animasi pulse saat idle (perlu cek teksnya) - Kurang ideal tanpa JS */
         /* #status:contains("Idle") { animation: none; } */


        /* --- Input/Output Section (Simplifikasi Judul) --- */
        .io-section {
            margin-bottom: 15px;
        }

        .io-section h2 {
            font-size: 0.8em;
            color: #888; /* Abu-abu sangat redup */
            font-weight: 300;
            text-align: center;
            margin-bottom: 5px;
            border: none; /* Hapus border */
            padding: 0;
        }

        /* --- Speech Bubbles (Desain Ulang) --- */
        .speech-bubble {
            padding: 12px 18px;
            border-radius: 15px;
            min-height: 35px;
            word-wrap: break-word;
            margin-top: 5px;
            line-height: 1.5;
            background-color: rgba(255, 255, 255, 0.1); /* Background semi transparan */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
            animation: popIn 0.4s ease-out forwards;
            opacity: 0; /* Mulai transparan untuk animasi */
            max-width: 90%; /* Biar nggak full width */
            margin-left: auto; /* Default align kanan */
            margin-right: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .speech-bubble.user {
            background-color: rgba(0, 255, 255, 0.15); /* Warna user (Cyan) */
            border-color: rgba(0, 255, 255, 0.3);
            margin-left: auto; /* Align kanan */
            margin-right: 10px; /* Sedikit jarak dari tepi */
            border-bottom-right-radius: 5px;
        }

        .speech-bubble.ai {
            background-color: rgba(200, 0, 255, 0.15); /* Warna AI (Ungu/Magenta) */
            border-color: rgba(200, 0, 255, 0.3);
            margin-left: 10px; /* Sedikit jarak dari tepi */
            margin-right: auto; /* Align kiri */
            border-bottom-left-radius: 5px;
        }

        /* --- Controls (Tombol Mic Fokus Utama Animasi) --- */
        .controls {
            text-align: center;
            margin: 25px 0;
        }

        #micButton {
            background: linear-gradient(45deg, #00aaaa, #00ffff); /* Gradient Cyan Idle */
            color: #111; /* Teks gelap kontras */
            border: none; /* Hapus border standar */
            width: 80px; /* Ukuran Bulat */
            height: 80px;
            border-radius: 50%; /* Bulat Sempurna */
            cursor: pointer;
            font-size: 1em; /* Ukuran teks di tombol jika ada */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Shadow dasar */
            animation: buttonIdleGlow 2s infinite ease-in-out; /* Animasi idle */
             overflow: hidden; /* Jaga-jaga ikon keluar */
        }

        #micButton svg.feather { /* Styling Ikon dalam Tombol */
             width: 36px;
             height: 36px;
             stroke-width: 1.5;
             color: #111; /* Warna ikon sama dengan teks tombol */
             transition: transform 0.3s ease;
        }

        /* Hilangkan Teks, Fokus Ikon (jika mau) */
        /* #micButton span { display: none; } */


        #micButton:hover:not(:disabled) {
            transform: scale(1.05); /* Sedikit membesar saat hover */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        #micButton:active:not(:disabled) {
             transform: scale(0.95); /* Sedikit mengecil saat ditekan */
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }


        /* State: Mendengarkan (Animasi Meriah Merah/Pink) */
        #micButton.listening {
            background: linear-gradient(45deg, #ff0055, #ff44cc); /* Gradient Pink/Merah */
            color: #fff; /* Teks/Ikon putih */
            animation: buttonListeningPulse 1s infinite ease-in-out; /* Animasi Pulse Meriah */
        }
         #micButton.listening svg.feather { color: #fff; }

        /* State: AI Berbicara (Animasi Meriah Ungu/Biru) */
        #micButton.ai-speaking {
             background: linear-gradient(135deg, #6a00ff, #aa00ff, #cc33ff, #6a00ff); /* Gradient Ungu Bergerak */
             background-size: 300% 100%;
             color: #fff;
             animation: buttonSpeakingWave 3s infinite linear; /* Animasi Gelombang */
        }
         #micButton.ai-speaking svg.feather { color: #fff; }

        /* State: Processing / Disabled (Simpel Abu) */
        #micButton:disabled {
            background: #666; /* Abu solid */
            color: #aaa;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: scale(1);
            animation: none; /* Hapus semua animasi */
        }
         #micButton:disabled svg.feather { color: #aaa; }

         /* Animasi Loading/Thinking (Jika ada ikon loader) */
         #micButton:disabled[innerHTML*="feather-loader"] {
             animation: thinkingShimmerSimple 1.5s linear infinite;
         }
          /* Ikon loader berputar */
         .feather-loader {
             animation: spin 1.5s linear infinite;
         }
         @keyframes spin {
             from { transform: rotate(0deg); }
             to { transform: rotate(360deg); }
         }


        .mic-info {
            font-size: 0.8em;
            color: #999;
            margin-top: 10px;
            transition: color 0.3s ease;
        }

        /* --- Transcript Section (Simpel) --- */
        .transcript-section {
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.15); /* Garis pemisah tipis */
            padding-top: 20px;
            width: 100%; /* Lebar penuh */
            max-width: 600px; /* Sesuaikan dengan container */
        }

        .transcript-section h2 {
            font-size: 0.9em;
            color: #bbb;
            font-weight: 400;
            margin-bottom: 10px;
            text-align: center;
        }

        #transcript {
            max-height: 200px; /* Tinggi secukupnya */
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.2); /* Background sedikit gelap */
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
        }

        /* Custom Scrollbar Simple (Webkit) */
        #transcript::-webkit-scrollbar { width: 6px; }
        #transcript::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; }
        #transcript::-webkit-scrollbar-thumb { background-color: #00ffff; border-radius: 3px; }
        #transcript::-webkit-scrollbar-thumb:hover { background-color: #ff00ff; }


        #transcript p {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dotted rgba(255, 255, 255, 0.2);
            line-height: 1.5;
            color: #ccc;
             /* Animasi masuk */
             animation: transcriptEntry 0.5s ease forwards;
             opacity: 0;
        }
        #transcript p:last-child { border-bottom: none; }
        #transcript p strong {
            color: #00ffcc; /* Warna speaker cerah */
            margin-right: 5px;
            font-weight: 600;
        }

    </style>
</head>
<body>

    <!-- === Struktur HTML Tidak Diubah Sama Sekali === -->
    <!-- (Komentar di bawah ini hanya untuk penanda, tidak akan tampil) -->
    <!-- Pastikan ID elemen seperti 'status', 'user-speech', 'ai-response', 'micButton', 'micInfoText', 'transcript' tetap sama -->

    <h1>AI Voice Call</h1> <!-- Judul lebih simpel -->
    <p style="font-size:0.9em; color:#666; text-align:center; margin-top:-10px; margin-bottom:15px;">Simple & Meriah Edition</p> <!-- Style inline ini akan ditimpa CSS di atas -->

    <div class="warning">
        ⚠️ PERINGATAN: API Key ada di dalam kode. Jangan dibagikan!
    </div>

    <div class="container">
        <div class="status-box">
            <strong>Status:</strong> <span id="status">Idle</span>
        </div>

        <div class="io-section">
            <h2>You Said:</h2> <!-- Judul IO disingkat -->
            <div id="user-speech" class="speech-bubble user">...</div>
        </div>

        <div class="io-section">
            <h2>AI Said:</h2>
            <div id="ai-response" class="speech-bubble ai">...</div>
        </div>

        <div class="controls">
            <button id="micButton" title="Klik untuk mulai/berhenti merekam atau menghentikan AI">
                <!-- Konten button (ikon & teks) akan diupdate oleh JS -->
                <!-- Kita desain agar ikon lebih dominan -->
            </button>
             <p class="mic-info" id="micInfoText">(Mic nonaktif. Klik tombol untuk memulai)</p>
        </div>

        <div class="transcript-section">
             <h2>History</h2> <!-- Judul transkrip disingkat -->
             <div id="transcript"></div>
        </div>
    </div>

    <script>
        // --- JavaScript TIDAK DIUBAH SEDIKITPUN ---
        // (Kode JS yang lu kasih sebelumnya ditempel di sini tanpa perubahan)
        document.addEventListener('DOMContentLoaded', () => {

    const TOGETHER_API_URL = 'https://api.together.xyz/v1/chat/completions';
    const AI_MODEL = 'meta-llama/Llama-3.3-70B-Instruct-Turbo-Free';
    const API_KEYS = [
         "15b70f2d5532d4056cb40a96dada4f41cd6be5206b3265abaa2bc8c1ce85de1b",
         "1986fcb80017badcac2c5761e9bc5d9b5b635a57b58573c094c5aaee0f7cad65",
         "47aacfae02634de54a494b4071c9fb357122f453c3ed25a848e77a32a39c50c2",
         "11eb49ac44759de26e65730a309d05a82e37a77d3547d94f154bd7a3a66de34d",
         "cf887a3d000a64a1686d2bb8e392a64b7f46fe131aff4685e5199510106b8608",
         "9fa71bf023b928a32cad2959fcf5fee36bb9fbb3732ed6ba659892c079da57e0",
         "401925c1ac6e2e33847169014115e9344dcaf32d1c1fe386c8fc92768d7b15ad",
         "215c434d7361a2799557f151ab3b3b80c710a09111339e712a82579f8790f7f2",
         "34211673816c9ef4729e0259c042ebe3d762fb90ff16c36b42ddfb1c0f9e10e6",
         "1ea461952d729c0e3dccadd919ee5d121a8125bc7bd5924192495528e24e2afb",
         "40f561d9befc36d117412f9003d81a2306790e536cec5c36ce540833885f6bd5",
         "f8eb6808a6c585445cd0db8cb5d048b9cb2d35262fe67f9b512ebc17eb4937b2",
         "f19df6a1c0a9dccb696764e091d8990734acdff7b39f811a873f7ddf580f92ff"
    ];

    function getRandomApiKey() {
        return API_KEYS[Math.floor(Math.random() * API_KEYS.length)];
    }
    // ---------------------------------------------------------------

    // Cek support Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SpeechSynthesis = window.speechSynthesis;

    if (!SpeechRecognition || !SpeechSynthesis) {
        alert("Maaf, browser lu nggak support Web Speech API. Coba pake Chrome.");
        document.getElementById('micButton').disabled = true;
        document.getElementById('micButton').textContent = 'Error'; // Teks simpel
        document.getElementById('status').textContent = 'Browser tidak support';
        return;
    }

    // Get Element DOM
    const micButton = document.getElementById('micButton');
    const statusDisplay = document.getElementById('status');
    const userSpeechDisplay = document.getElementById('user-speech');
    const aiResponseDisplay = document.getElementById('ai-response');
    const transcriptDisplay = document.getElementById('transcript');
    const micInfoText = document.getElementById('micInfoText');

    // Ikon SVG (tidak berubah)
    const micIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
    const stopIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
    const speakerIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
    const thinkingIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-loader"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>`;

    // Inisialisasi Speech Recognition (STT)
    const recognition = new SpeechRecognition();
    recognition.lang = 'id-ID';
    recognition.interimResults = true; // Tampilkan hasil sementara
    recognition.continuous = false; // Berhenti setelah jeda

    // State aplikasi
    let isListening = false;
    let isAISpeaking = false; // State umum AI sedang aktif (bicara atau di antrian)
    let finalTranscript = '';

    // Variabel untuk Antrian TTS
    let speechChunkQueue = []; // Antrian untuk potongan teks
    let currentUtterance = null; // Referensi ke utterance yang sedang dibaca

    // History Percakapan (tidak berubah)
    let chatHistory = [
        { role: "system", content: "Kamu adalah asisten AI bernama kartini ai yang realistis ramah dan membantu dalam bahasa indonesia. jangan terlalu kaku seperti ai lainnya, jawab dengan singkat jika memungkinkan." }
    ];

    // Fungsi untuk update tampilan tombol (JS ini tidak diubah, tapi CSS akan merespon class yg ditambah/dihapus)
    function updateMicButton(state, text) {
        micButton.disabled = false;
        micButton.classList.remove('listening', 'ai-speaking'); // Hapus class state sebelumnya

        let icon = micIconSVG;
        // Teks di tombol sekarang kurang relevan karena kita fokus ikon, tapi biarkan logikanya
        let buttonText = ""; // Kosongkan teks default, JS mungkin masih isi
        let infoText = "(Klik tombol bulat untuk mulai)"; // Info lebih simpel

        switch (state) {
            case 'listening':
                isListening = true;
                icon = stopIconSVG;
                buttonText = ""; // Kosongkan
                infoText = "Sedang mendengarkan...";
                micButton.classList.add('listening'); // Tambah class untuk styling CSS
                break;
            case 'processing':
                icon = thinkingIconSVG;
                buttonText = ""; // Kosongkan
                infoText = "AI sedang berpikir...";
                micButton.disabled = true;
                // Class 'thinking' tidak ada, tapi CSS bisa target :disabled dan ikon loader
                break;
            case 'ai_speaking':
                isAISpeaking = true;
                icon = speakerIconSVG; // Atau ikon stop? Biarkan speaker saja
                buttonText = ""; // Kosongkan
                infoText = "AI sedang bicara (Klik tombol untuk stop)";
                micButton.classList.add('ai-speaking'); // Tambah class untuk styling CSS
                // Tombol tetap bisa diklik untuk stop
                break;
            case 'idle':
            default:
                isListening = false;
                isAISpeaking = false;
                icon = micIconSVG;
                buttonText = ""; // Kosongkan
                infoText = "(Mic nonaktif. Klik tombol untuk memulai)";
                // Tidak ada class khusus untuk idle, state default
                break;
        }
        // Set innerHTML dengan ikon (dan teks jika ada - kita coba sembunyikan via CSS)
        micButton.innerHTML = `${icon} <span style="display: none;">${text || buttonText}</span>`; // Sembunyikan span teks
        micInfoText.textContent = infoText;
    }

    // --- Event Listener untuk Speech Recognition (tidak berubah) ---
    recognition.onstart = () => {
        console.log('Speech Recognition Dimulai');
        updateMicButton('listening'); // Update tombol (tanpa teks)
        statusDisplay.textContent = 'Mendengarkan...';
        userSpeechDisplay.textContent = '...';
        finalTranscript = '';
        // Animasi popIn user bubble akan ditrigger oleh CSS saat konten berubah/muncul
        userSpeechDisplay.style.opacity = '0'; // Reset opacity untuk animasi
        setTimeout(() => userSpeechDisplay.style.opacity = '1', 50); // Delay kecil
    };

    recognition.onresult = (event) => {
        let interimTranscript = '';
        let currentFinal = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcriptPart = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                currentFinal += transcriptPart + ' ';
            } else {
                interimTranscript += transcriptPart;
            }
        }
        finalTranscript += currentFinal;
        const displayTranscript = finalTranscript.trim() || interimTranscript || '...';
        if(userSpeechDisplay.textContent !== displayTranscript) {
             userSpeechDisplay.textContent = displayTranscript;
             // Pastikan bubble terlihat jika ada hasil sementara
             if (displayTranscript !== '...') userSpeechDisplay.style.opacity = '1';
        }
    };

    recognition.onend = () => {
        console.log('Speech Recognition Selesai.');
        const wasListeningState = isListening; // Simpan state sebelum reset
        isListening = false; // Reset state listening

        // Jika dihentikan karena AI mau/sedang bicara, jangan proses transcript atau ubah UI ke idle
        if (isAISpeaking) {
            console.log('Recognition dihentikan karena AI akan/sedang berbicara.');
            // Biarkan state tombol & status diatur oleh alur AI speaking
            return;
        }

        const processedTranscript = finalTranscript.trim();

        // Hanya proses jika ada transcript DAN user memang sedang dalam state mendengarkan
        if (processedTranscript && wasListeningState) {
            console.log('Final Transcript:', processedTranscript);
            statusDisplay.textContent = 'Mengirim ke AI...';
            updateMicButton('processing'); // Update ke state loading
            addToTranscript("User", processedTranscript); // Tambah ke history UI

            // Tambahkan ke history chat untuk AI
            chatHistory.push({ role: "user", content: processedTranscript });
            console.log("Updated Chat History (User added):", JSON.stringify(chatHistory));

            sendToAI(); // Kirim ke AI
        }
        // Jika tidak ada transcript DAN user memang sedang mendengarkan (misal, klik stop tanpa ngomong)
        else if (wasListeningState) {
             statusDisplay.textContent = 'Idle (Tidak ada ucapan)';
             userSpeechDisplay.textContent = '(Diam...)'; // Pesan lebih santai
             userSpeechDisplay.style.opacity = '1'; // Tampilkan pesan diam
             updateMicButton('idle'); // Kembali ke idle
        }
        // Kasus lain (misal, onend dipanggil karena error atau kondisi lain)
        else {
            // Hanya update ke idle jika tidak ada proses lain (AI speaking)
            if (!isAISpeaking) {
               statusDisplay.textContent = 'Idle';
               updateMicButton('idle');
            }
        }
        finalTranscript = ''; // Reset final transcript
    };

    recognition.onerror = (event) => {
        console.error('Speech Recognition Error:', event.error);
        isListening = false;
        let errorMessage = 'Error Mic: ' + event.error;
        if (event.error === 'no-speech') {
             errorMessage = 'Nggak ada suara? Coba lagi.';
         } else if (event.error === 'audio-capture') {
             errorMessage = 'Error: Mic bermasalah?';
         } else if (event.error === 'not-allowed') {
             errorMessage = 'Error: Izin mic ditolak!';
         }
        statusDisplay.textContent = errorMessage;
        userSpeechDisplay.textContent = '(Error Mic)';
        userSpeechDisplay.style.opacity = '1';
        updateMicButton('idle', 'Error Mic'); // Update tombol ke idle dengan pesan error (tersembunyi)
    };

    // --- Fungsi Parsing Output AI (tidak berubah) ---
    function parseAIOutput(text) {
         const cleanedText = text.replace(/[*~`:]/g, ''); // Hapus beberapa karakter markdown/spesial lain
         return cleanedText.trim();
    }

    // --- Fungsi untuk Text-to-Speech (TTS) dengan Chunking (tidak berubah) ---
    function speak(fullText) {
        if (SpeechSynthesis.speaking || speechChunkQueue.length > 0) {
            console.warn('SpeechSynthesis/Queue aktif - Membatalkan sebelumnya...');
            SpeechSynthesis.cancel();
            speechChunkQueue = [];
            if (currentUtterance) {
                currentUtterance.onend = null;
                currentUtterance.onerror = null;
            }
            currentUtterance = null;
        }
        isAISpeaking = false; // Reset state awal

        const displayText = parseAIOutput(fullText);
        aiResponseDisplay.textContent = displayText || "..."; // Tampilkan teks lengkap segera
        aiResponseDisplay.style.opacity = '0'; // Reset opacity untuk animasi
        setTimeout(() => aiResponseDisplay.style.opacity = '1', 50); // Delay kecil
        addToTranscript("AI", displayText); // Tambah ke history UI

        if (!displayText) {
            console.log("Tidak ada teks untuk diucapkan AI.");
            handleSpeechEnd(); // Langsung panggil akhir jika teks kosong
            return;
        }

        const chunks = displayText.match(/[^.!?,\n]+([.!?,\n]+|$)/g) || [displayText];
        speechChunkQueue = chunks.map(s => s.trim()).filter(s => s.length > 0);

        console.log(`Teks dipecah jadi ${speechChunkQueue.length} chunk(s).`);

        if (speechChunkQueue.length > 0) {
            isAISpeaking = true; // Set state utama AI sedang aktif
            updateMicButton('ai_speaking'); // Update tombol ke state AI bicara
            statusDisplay.textContent = 'AI Bicara...';

            if (isListening) {
                console.log('AI mulai bicara, menghentikan user recognition...');
                recognition.stop(); // Hentikan user jika sedang mendengar
            }
            speakNextChunk(); // Mulai bicara chunk pertama
        } else {
            console.log("Setelah dipecah, tidak ada chunk valid untuk dibicarakan.");
            handleSpeechEnd(); // Tidak ada yg dibicarakan, anggap selesai
        }
    }

    function speakNextChunk() {
        if (speechChunkQueue.length === 0) {
            console.log("--- Semua chunk selesai dibicarakan ---");
            handleSpeechEnd(); // Panggil fungsi akhir terpusat
            return;
        }

        const chunk = speechChunkQueue.shift();
        currentUtterance = new SpeechSynthesisUtterance(chunk);
        currentUtterance.lang = 'id-ID';
        currentUtterance.pitch = 1.1;
        currentUtterance.rate = 1.2; // Kecepatan bisa diatur

        const voices = SpeechSynthesis.getVoices();
        const indoVoice = voices.find(voice => voice.lang === 'id-ID' && voice.name.includes('Google'));
        if (indoVoice) {
            currentUtterance.voice = indoVoice;
        } else if (voices.length === 0) {
            SpeechSynthesis.onvoiceschanged = () => {
                const loadedVoices = SpeechSynthesis.getVoices();
                const loadedIndoVoice = loadedVoices.find(voice => voice.lang === 'id-ID' && voice.name.includes('Google'));
                if (loadedIndoVoice && currentUtterance) {
                    currentUtterance.voice = loadedIndoVoice;
                }
                SpeechSynthesis.onvoiceschanged = null;
            };
        }

        currentUtterance.onstart = () => {
            console.log(`Mulai bicara chunk: "${chunk.substring(0, 40)}..."`);
        };

        currentUtterance.onend = () => {
            console.log(`Selesai bicara chunk.`);
            currentUtterance = null;
            // Jeda sedikit sebelum lanjut, penting!
            setTimeout(speakNextChunk, 100); // Jeda 100ms
        };

        currentUtterance.onerror = (event) => {
            console.error('SpeechSynthesis Error pada chunk:', event.error, "Chunk:", chunk);
            currentUtterance = null;
            speechChunkQueue = []; // Hentikan semua jika ada error
            handleSpeechEnd(true); // Panggil fungsi akhir dengan flag error
        };

        SpeechSynthesis.speak(currentUtterance);
    }

    // --- Fungsi Terpusat untuk Menangani Akhir TTS (tidak berubah) ---
    function handleSpeechEnd(isError = false) {
        const wasSpeaking = isAISpeaking;
        isAISpeaking = false;
        currentUtterance = null;
        // Queue harusnya sudah kosong

        if (isError) {
            statusDisplay.textContent = 'Error saat AI bicara.';
            updateMicButton('idle', 'Error AI Speech');
        } else if (wasSpeaking) {
            statusDisplay.textContent = 'Giliranmu! (Mic otomatis aktif)'; // Lebih santai
            updateMicButton('idle', 'Mic Siap'); // Kembalikan ke idle siap

            console.log('AI selesai normal, otomatis aktifkan mic...');
            setTimeout(() => {
                // Cek lagi state sebelum start, user mungkin sudah klik manual
                if (!isListening && !isAISpeaking) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(() => {
                            if (!isListening && !isAISpeaking) { // Cek lagi
                                try {
                                    recognition.start();
                                } catch (e) {
                                    console.error("Gagal start recognition otomatis setelah TTS:", e);
                                     statusDisplay.textContent = "Gagal aktifkan mic.";
                                     updateMicButton('idle'); // Tetap idle jika error start
                                }
                            } else {
                                 console.log("Mic sudah aktif manual / AI bicara lagi, skip auto-start.")
                            }
                        })
                        .catch(err => {
                            console.error("Gagal dapat izin mic otomatis:", err);
                            statusDisplay.textContent = "Izinkan mic untuk lanjut.";
                            updateMicButton('idle', 'Butuh Izin Mic');
                        });
                } else {
                    console.log('Mic sudah aktif atau AI bicara lagi, tidak perlu start otomatis.');
                }
            }, 500); // Jeda 0.5 detik sebelum mic on
        } else {
            // Dipanggil karena cancel sebelum mulai bicara?
            console.log("handleSpeechEnd dipanggil tapi AI tidak dalam state 'speaking'. Mungkin dibatalkan.");
            if (!isListening) { // Pastikan user tidak lagi didengarkan
                 updateMicButton('idle');
                 statusDisplay.textContent = 'Idle (AI Dibatalkan)';
            }
        }
    }

    // --- Fungsi untuk Mengirim Teks ke Together AI (tidak berubah) ---
    async function sendToAI() {
        aiResponseDisplay.style.opacity = '0'; // Reset opacity untuk animasi
        aiResponseDisplay.textContent = '...';

        const apiKey = getRandomApiKey();
        if (!apiKey) {
            statusDisplay.textContent = 'Error: API Key kosong!';
            updateMicButton('idle', 'Error API');
            aiResponseDisplay.textContent = 'Error Konfigurasi';
             aiResponseDisplay.style.opacity = '1';
            return;
        }

        const maxHistoryLength = 11; // Jumlah history (system + 5 pasang user-AI)
        const currentHistory = chatHistory.length <= maxHistoryLength
            ? [...chatHistory]
            : [chatHistory[0], ...chatHistory.slice(-maxHistoryLength + 1)];

        const payload = {
            model: AI_MODEL,
            messages: currentHistory,
            max_tokens: 250, // Batas token respons
            temperature: 0.5, // Sedikit lebih kreatif
            top_p: 0.9,
            frequency_penalty: 0.4, // Kurangi pengulangan
            presence_penalty: 0.3, // Dorong topik baru sedikit
        };

        console.log("Mengirim request ke Together AI:", JSON.stringify(payload, null, 2));

        try {
            const response = await fetch(TOGETHER_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(payload)
            });

            console.log(`Status Response Together AI: ${response.status} ${response.statusText}`);

            if (!response.ok) {
                let errorBody = "Error tidak diketahui";
                try { errorBody = await response.text(); console.error("Error Body:", errorBody); } catch (e) { /* abaikan */ }
                throw new Error(`API error ${response.status}: ${response.statusText}. Detail: ${errorBody}`);
            }

            const data = await response.json();
            console.log("Response JSON dari Together AI diterima.");

            if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                const rawAiReply = data.choices[0].message.content.trim();
                console.log("Jawaban AI (Mentah):", rawAiReply);

                // Panggil speak dengan teks mentah, parsing & chunking di dalam speak()
                speak(rawAiReply);

                // Tambahkan jawaban yang sudah diparsing ke history chat (setelah dikirim ke speak)
                const cleanedForHistory = parseAIOutput(rawAiReply);
                chatHistory.push({ role: "assistant", content: cleanedForHistory });
                console.log("Updated Chat History (AI added):", JSON.stringify(chatHistory));

            } else {
                console.error("Struktur response Together AI tidak sesuai:", data);
                throw new Error("Format response AI tidak dikenali.");
            }

        } catch (error) {
            console.error('Error fetching AI response:', error);
            statusDisplay.textContent = 'Error koneksi ke AI.';
            aiResponseDisplay.textContent = `Gagal hubungi AI: ${error.message}`;
             aiResponseDisplay.style.opacity = '1';
            updateMicButton('idle', 'Error AI');

            // Hapus pesan user terakhir dari history jika AI gagal
            if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                chatHistory.pop();
                console.log("AI Error: Pesan user terakhir dihapus dari history.");
            }
            handleSpeechEnd(true); // Reset state TTS jika AI error
        }
    }

    // --- Fungsi Tambah ke Transkrip (tidak berubah) ---
    function addToTranscript(speaker, text) {
        const p = document.createElement('p');
        p.innerHTML = `<strong>${speaker}:</strong> ${text}`;
        // CSS akan handle animasi masuknya
        transcriptDisplay.appendChild(p);
        // Auto scroll ke bawah
        transcriptDisplay.scrollTop = transcriptDisplay.scrollHeight;
    }

    // --- Event Listener untuk Tombol Mic (tidak berubah) ---
    micButton.addEventListener('click', () => {
         console.log(`Tombol diklik. Status: isListening=${isListening}, isAISpeaking=${isAISpeaking}, Queue length=${speechChunkQueue.length}`);

         // Jika AI sedang bicara ATAU ada antrian TTS
         if (isAISpeaking || speechChunkQueue.length > 0) {
            console.log('User menghentikan AI...');
            speechChunkQueue = []; // Kosongkan antrian
            SpeechSynthesis.cancel(); // Hentikan suara yg lagi jalan
            // handleSpeechEnd akan dipanggil otomatis oleh event onend/onerror utterance,
            // atau kita panggil manual di sini untuk memastikan UI update
            handleSpeechEnd(false); // Anggap cancel oleh user bukan error
         }
         // Jika sedang mendengarkan (user mau stop rekam)
         else if (isListening) {
            console.log('User menghentikan rekaman...');
            recognition.stop(); // Ini akan memicu recognition.onend
            // UI akan diupdate di onend
         }
         // Jika idle (user mau mulai rekam)
         else {
            console.log('User memulai rekaman...');
            // Pastikan AI tidak sedang proses (misal, jeda antar chunk)
            if (SpeechSynthesis.speaking) {
                 console.warn("Mencoba mulai rekam saat AI masih proses, batalkan AI dulu.");
                 SpeechSynthesis.cancel();
                 handleSpeechEnd(false);
                 // Jangan langsung mulai rekam, biarkan user klik lagi setelah cancel
                 return;
            }

            // Minta izin mic dulu (best practice)
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(() => {
                    console.log("Izin mic OK, memulai recognition...");
                     try {
                         // Cek lagi kalau state berubah cepat
                         if (!isListening && !isAISpeaking) {
                             recognition.start(); // onstart akan handle UI
                         }
                     } catch (e) {
                         // Error jika sudah jalan atau state lain
                         if (e.name === 'InvalidStateError') {
                             console.warn("Recognition gagal start, mungkin sudah aktif?");
                         } else {
                             console.error("Gagal start recognition:", e);
                             statusDisplay.textContent = "Gagal mulai rekam.";
                             updateMicButton('idle', 'Error Start');
                         }
                     }
                })
                .catch(err => {
                    console.error("Error meminta izin mic:", err);
                    statusDisplay.textContent = 'Error: Izinkan mic dulu!';
                    alert("Bro, izinin mic di browser ya buat pake fitur ini.");
                    updateMicButton('idle', 'Butuh Izin Mic');
                });
        }
    });

    // --- Inisialisasi Awal (tidak berubah) ---
    updateMicButton('idle'); // Set tombol awal
    statusDisplay.textContent = 'Siap';
    // Tampilkan bubble awal dengan animasi
    userSpeechDisplay.style.opacity = '0'; setTimeout(() => userSpeechDisplay.style.opacity = '1', 50);
    aiResponseDisplay.style.opacity = '0'; setTimeout(() => aiResponseDisplay.style.opacity = '1', 100); // Sedikit delay
    userSpeechDisplay.textContent = '(Nanti ucapanmu muncul di sini)';
    aiResponseDisplay.textContent = '(Jawaban AI muncul di sini)';

    // Pre-load voices (tidak berubah)
    const preloadVoices = () => {
        const voices = SpeechSynthesis.getVoices();
        if (voices.length > 0) {
            console.log("Voices loaded:", voices.length);
            const indoVoice = voices.find(voice => voice.lang === 'id-ID' && voice.name.includes('Google'));
            if(indoVoice) console.log("Suara Google id-ID ditemukan:", indoVoice.name);
            else console.log("Suara Google id-ID tidak ditemukan.");
            SpeechSynthesis.onvoiceschanged = null;
        }
    };
    preloadVoices();
    if (SpeechSynthesis.onvoiceschanged !== undefined) {
        SpeechSynthesis.onvoiceschanged = preloadVoices;
    }

    console.log("Aplikasi Voice Call Simple & Meriah Siap.");
     if (API_KEYS.length === 0) {
         console.warn("PERINGATAN: List API Key kosong!");
         statusDisplay.textContent = 'Error: API Key kosong!';
         updateMicButton('idle', 'Error API');
         micButton.disabled = true;
     } else {
          console.warn("PERINGATAN KEAMANAN: API Key terlihat di kode sumber!");
     }

});
    </script>

</body>
</html>
