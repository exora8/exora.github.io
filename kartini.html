document.addEventListener('DOMContentLoaded', () => {
    // Cek support Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SpeechSynthesis = window.speechSynthesis;

    if (!SpeechRecognition || !SpeechSynthesis) {
        alert("Maaf, browser lu nggak support Web Speech API. Coba pake Chrome.");
        return;
    }

    // Get Element DOM
    const micButton = document.getElementById('micButton');
    const statusDisplay = document.getElementById('status');
    const userSpeechDisplay = document.getElementById('user-speech');
    const aiResponseDisplay = document.getElementById('ai-response');
    const transcriptDisplay = document.getElementById('transcript');
    const micIcon = micButton.querySelector('svg'); // Ambil ikon mic

    // Inisialisasi Speech Recognition (STT)
    const recognition = new SpeechRecognition();
    recognition.lang = 'id-ID'; // Set bahasa ke Indonesia
    recognition.interimResults = true; // Tampilkan hasil sementara
    recognition.continuous = false; // Berhenti setelah user berhenti bicara sejenak

    // State aplikasi
    let isListening = false;
    let finalTranscript = ''; // Menyimpan transkrip final dari user

    // --- Event Listener untuk Speech Recognition ---

    recognition.onstart = () => {
        isListening = true;
        statusDisplay.textContent = 'Mendengarkan...';
        micButton.classList.add('listening');
        micButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
            Berhenti Bicara
        `; // Ganti ikon & teks
        userSpeechDisplay.textContent = '...'; // Reset tampilan user
        aiResponseDisplay.textContent = '...'; // Reset tampilan AI
        finalTranscript = ''; // Reset transkrip final
        console.log('Speech Recognition Dimulai');
    };

    recognition.onresult = (event) => {
        let interimTranscript = '';
        finalTranscript = ''; // Reset final transcript setiap ada hasil baru

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }

        // Update tampilan dengan hasil sementara atau final
        userSpeechDisplay.textContent = finalTranscript || interimTranscript;

        // Jika hasil sudah final, proses lebih lanjut
        if (finalTranscript) {
             console.log('Final Transcript:', finalTranscript);
             // Otomatis kirim ke AI setelah final (jika diinginkan, atau tunggu tombol stop)
             // Untuk "smart mic" manual, kita tunggu onend()
        }
    };

    recognition.onend = () => {
        isListening = false;
        statusDisplay.textContent = 'Memproses...';
        micButton.classList.remove('listening');
         micButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            Mulai Bicara
        `; // Kembalikan ikon & teks

        console.log('Speech Recognition Selesai.');

        // Kirim hasil final ke AI jika ada
        if (finalTranscript.trim()) {
            addToTranscript("User", finalTranscript);
            sendToAI(finalTranscript);
        } else {
             statusDisplay.textContent = 'Idle (Tidak ada ucapan terdeteksi)';
        }
    };

    recognition.onerror = (event) => {
        isListening = false; // Pastikan state benar
        micButton.classList.remove('listening');
        micButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            Mulai Bicara
        `; // Kembalikan ikon & teks
        console.error('Speech Recognition Error:', event.error);
        let errorMessage = 'Error: ' + event.error;
         if (event.error === 'no-speech') {
             errorMessage = 'Tidak ada suara terdeteksi. Coba lagi.';
         } else if (event.error === 'audio-capture') {
             errorMessage = 'Error: Tidak bisa menangkap audio. Cek mikrofon.';
         } else if (event.error === 'not-allowed') {
             errorMessage = 'Error: Izin mikrofon ditolak. Izinkan di setting browser.';
         }
        statusDisplay.textContent = errorMessage;
        userSpeechDisplay.textContent = '...';
    };

    // --- Fungsi untuk Text-to-Speech (TTS) ---
    function speak(text) {
        // Jika sedang bicara, hentikan dulu (opsional)
        if (SpeechSynthesis.speaking) {
            console.log('SpeechSynthesis.speaking - Canceling previous utterance');
            SpeechSynthesis.cancel();
        }

        statusDisplay.textContent = 'AI Berbicara...';
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'id-ID'; // Bahasa Indonesia
        utterance.pitch = 1;
        utterance.rate = 1; // Kecepatan normal

        utterance.onstart = () => {
            console.log('SpeechSynthesis Mulai');
            micButton.disabled = true; // Disable mic saat AI bicara
        };

        utterance.onend = () => {
            console.log('SpeechSynthesis Selesai');
            statusDisplay.textContent = 'Idle';
            micButton.disabled = false; // Enable mic lagi
            // Mungkin otomatis mulai listening lagi? (Tergantung flow)
            // if (!isListening) {
            //     micButton.click(); // Jika ingin otomatis listen lagi
            // }
        };

        utterance.onerror = (event) => {
            console.error('SpeechSynthesis Error:', event.error);
            statusDisplay.textContent = 'Error saat AI bicara.';
            micButton.disabled = false; // Pastikan mic enable jika error
        };

        aiResponseDisplay.textContent = text; // Tampilkan teks AI
        addToTranscript("AI", text); // Tambah ke transkrip
        SpeechSynthesis.speak(utterance);
    }

    // --- Fungsi untuk Mengirim Teks ke Backend AI ---
    async function sendToAI(text) {
        statusDisplay.textContent = 'AI Berpikir...';
        aiResponseDisplay.textContent = '...'; // Tampilkan loading

        // **INI BAGIAN PENTING:** Ganti URL '/api/chat' dengan endpoint backend lu
        const backendUrl = '/api/chat'; // <<< GANTI INI

        try {
            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: text }), // Kirim teks user
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.reply) {
                speak(data.reply); // AI menjawab via suara dan teks
            } else {
                 throw new Error("Format respons backend tidak sesuai (tidak ada 'reply')");
            }

        } catch (error) {
            console.error('Error fetching AI response:', error);
            statusDisplay.textContent = 'Error koneksi ke AI.';
            aiResponseDisplay.textContent = `Gagal menghubungi AI: ${error.message}`;
             // Bisa coba kasih pesan error default via TTS jika mau
             // speak("Maaf, terjadi kesalahan saat menghubungi AI.");
        }
    }

    // --- Fungsi Tambah ke Transkrip ---
    function addToTranscript(speaker, text) {
        const p = document.createElement('p');
        p.innerHTML = `<strong>${speaker}:</strong> ${text}`;
        transcriptDisplay.appendChild(p);
        // Auto-scroll ke bawah
        transcriptDisplay.scrollTop = transcriptDisplay.scrollHeight;
    }

    // --- Event Listener untuk Tombol Mic ---
    micButton.addEventListener('click', () => {
        if (isListening) {
            recognition.stop(); // Berhenti merekam jika sedang merekam
            // `onend` akan otomatis dipanggil setelah ini
        } else {
            // Minta izin mikrofon jika belum pernah
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(() => {
                     // Izin didapat atau sudah ada
                    console.log("Izin mic OK, memulai recognition...");
                    recognition.start(); // Mulai merekam jika tidak sedang merekam
                })
                .catch(err => {
                    console.error("Error meminta izin mic:", err);
                    statusDisplay.textContent = 'Error: Izin mikrofon ditolak/diperlukan.';
                     if (!micButton.classList.contains('listening')) {
                        micButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic-off"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                            Izin Mic?
                        `;
                    }
                });
        }
    });

    // --- Inisialisasi Awal ---
    statusDisplay.textContent = 'Siap';
    userSpeechDisplay.textContent = '...';
    aiResponseDisplay.textContent = '...';
    // Tes suara awal (opsional)
    // speak("Halo! Saya siap membantu.");
});
