<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Call (Smart Mic) v2 - History + Parsing</title>
    <style>
        /* --- [UI MEWAH BARU] CSS - Fokus di sini --- */

        /* Import Font (Opsional, tapi menambah kesan mewah) */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        /* Keyframes untuk Animasi Halus */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); } /* Gold semi-transparan */
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }

        @keyframes thinkingShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* --- Base Style --- */
        body {
            font-family: 'Poppins', sans-serif; /* Font lebih modern */
            background-color: #1a1a1a; /* Hitam pekat */
            color: #e0e0e0; /* Abu-abu terang untuk teks */
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 40px 20px; /* Lebih banyak padding atas/bawah */
            line-height: 1.7;
            min-height: 100vh; /* Pastikan background full height */
            box-sizing: border-box;
        }

        /* --- Judul & Header --- */
        h1 {
            color: #FFD700; /* Emas */
            font-weight: 600;
            margin-bottom: 5px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); /* Subtle glow emas */
            animation: fadeIn 0.8s ease-out;
        }

        body > p:first-of-type { /* Subjudul di bawah H1 */
            font-size: 0.95em;
            color: #aaa; /* Abu-abu lebih gelap */
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
            animation: fadeIn 0.9s ease-out;
        }

        /* --- Peringatan --- */
        .warning {
            background-color: rgba(255, 215, 0, 0.1); /* Background emas transparan */
            color: #FFD700; /* Teks Emas */
            border: 1px solid rgba(255, 215, 0, 0.4); /* Border emas semi-transparan */
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            font-weight: 400; /* Sedikit lebih tipis */
            font-size: 0.9em;
            animation: fadeIn 1s ease-out;
        }

        /* --- Kontainer Utama --- */
        .container {
            background-color: #2b2b2b; /* Abu-abu gelap */
            padding: 35px; /* Padding lebih besar */
            border-radius: 12px; /* Sudut lebih tumpul */
            /* Box shadow halus untuk depth di dark mode */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            max-width: 650px; /* Sedikit lebih lebar */
            width: 100%;
            box-sizing: border-box;
            animation: fadeIn 1.2s ease-out;
            border-top: 3px solid #FFD700; /* Aksen emas di atas */
        }

        /* --- Status Box --- */
        .status-box {
            background-color: rgba(255, 255, 255, 0.05); /* Background semi-transparan */
            padding: 12px 18px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid #444; /* Border abu-abu halus */
        }

        .status-box strong {
            color: #aaa; /* Abu-abu medium */
            font-weight: 400;
        }

        #status {
            font-weight: 600;
            color: #FFD700; /* Status Emas */
            transition: color 0.3s ease; /* Transisi warna halus */
        }

        /* --- Input/Output Section --- */
        .io-section {
            margin-bottom: 25px;
        }

        .io-section h2 {
            font-size: 1em; /* Sedikit lebih kecil */
            color: #bbb; /* Abu-abu terang */
            font-weight: 400;
            margin-bottom: 10px;
            border-bottom: 1px solid #444; /* Garis pemisah abu-abu */
            padding-bottom: 8px;
        }

        /* --- Speech Bubbles --- */
        .speech-bubble {
            padding: 15px 20px;
            border-radius: 18px;
            min-height: 45px;
            word-wrap: break-word;
            background-color: #3a3a3a; /* Abu-abu lebih gelap */
            color: #e0e0e0;
            margin-top: 8px;
            line-height: 1.6;
            transition: background-color 0.3s ease, transform 0.3s ease;
             animation: fadeIn 0.5s ease forwards; /* Animasi fade in saat muncul (jika JS merender ulang) */
             opacity: 0; /* Mulai transparan untuk animasi */
        }

         /* Animasi saat konten bubble berubah (jika JS mengganti konten) */
         .speech-bubble:not(:empty) {
             opacity: 1;
         }

        .speech-bubble.user {
            background-color: rgba(255, 215, 0, 0.15); /* Background Emas User transparan */
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #f0f0f0; /* Teks lebih terang */
            border-bottom-right-radius: 5px; /* Sudut khas chat */
            text-align: right;
        }

        .speech-bubble.ai {
            background-color: #444; /* Abu-abu sedikit beda */
             border: 1px solid #555;
            border-bottom-left-radius: 5px; /* Sudut khas chat */
        }

        /* --- Controls (Tombol Mic) --- */
        .controls {
            text-align: center;
            margin-bottom: 30px; /* Jarak lebih */
            margin-top: 10px; /* Jarak dari AI response */
        }

        #micButton {
            background: linear-gradient(145deg, #444, #222); /* Gradient Abu Gelap */
            color: #e0e0e0;
            border: 1px solid #555; /* Border halus */
            padding: 15px 30px; /* Lebih besar */
            border-radius: 50px; /* Pill shape sempurna */
            cursor: pointer;
            font-size: 1.05em; /* Sedikit lebih besar */
            font-weight: 400;
            display: inline-flex;
            align-items: center;
            gap: 10px; /* Jarak ikon & teks */
            transition: all 0.3s ease-out; /* Transisi lebih smooth */
            min-width: 200px;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.05); /* Shadow dalam & luar */
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
        }

        #micButton:hover:not(:disabled) {
            background: linear-gradient(145deg, #555, #333); /* Gradient lebih terang saat hover */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.1);
            transform: translateY(-2px); /* Efek angkat sedikit */
            color: #fff; /* Teks lebih putih */
            border-color: #666;
        }

        #micButton:active:not(:disabled) {
             transform: translateY(0px); /* Kembali saat ditekan */
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        /* State: Mendengarkan */
        #micButton.listening {
            background: linear-gradient(145deg, #7d2a33, #4a1a1f); /* Gradient Merah Gelap */
            border-color: #9c4a53;
            color: #fff;
            /* Animasi Pulse Emas */
            animation: pulseGlow 1.5s infinite ease-in-out;
        }
        #micButton.listening:hover:not(:disabled) {
             background: linear-gradient(145deg, #8d3a43, #5a2a2f);
             box-shadow: 0 6px 15px rgba(255, 215, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.1); /* Glow emas */
        }

        /* State: AI Berbicara */
        #micButton.ai-speaking {
            background: linear-gradient(145deg, #2a5a7d, #1a3a4f); /* Gradient Biru Gelap */
            border-color: #4a7a9c;
            color: #fff;
            /* Efek glow emas statis (opsional, bisa juga pulse) */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }
         #micButton.ai-speaking:hover:not(:disabled) {
             background: linear-gradient(145deg, #3a6a8d, #2a4a5f);
             box-shadow: 0 0 15px rgba(255, 215, 0, 0.7), 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.1);
         }


        /* State: Processing / Disabled */
        #micButton:disabled {
            background: #333; /* Abu solid */
            color: #777; /* Teks redup */
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Shadow lebih flat */
            transform: translateY(0); /* Hapus efek angkat */
            border-color: #444;
        }
         /* Animasi Loading/Thinking (jika tombol disabled karena processing) */
         #micButton:disabled[innerHTML*="feather-loader"] { /* Target saat ikon loader ada */
             background: linear-gradient(90deg, #333, #555, #333);
             background-size: 200% 100%;
             animation: thinkingShimmer 2s linear infinite;
         }


        .mic-info {
            font-size: 0.85em;
            color: #888; /* Abu-abu lebih gelap lagi */
            margin-top: 15px; /* Jarak lebih */
            transition: color 0.3s ease;
        }

        /* --- Transcript Section --- */
        .transcript-section {
            margin-top: 30px;
            border-top: 1px solid #444; /* Garis pemisah abu-abu */
            padding-top: 25px;
        }

        .transcript-section h2 {
            font-size: 1em;
            color: #bbb;
            font-weight: 400;
            margin-bottom: 15px;
        }

        #transcript {
            max-height: 250px; /* Sedikit lebih tinggi */
            overflow-y: auto;
            background-color: #222; /* Background lebih gelap */
            border: 1px solid #444;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        /* Custom Scrollbar (Webkit) */
        #transcript::-webkit-scrollbar {
            width: 8px;
        }
        #transcript::-webkit-scrollbar-track {
            background: #2b2b2b;
            border-radius: 4px;
        }
        #transcript::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
            border: 2px solid #2b2b2b;
        }
        #transcript::-webkit-scrollbar-thumb:hover {
            background-color: #FFD700; /* Scrollbar emas saat hover */
        }


        #transcript p {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dotted #555; /* Garis putus abu-abu */
            line-height: 1.6;
            /* Animasi halus saat ditambahkan (jika memungkinkan tanpa JS) */
            /* animation: fadeIn 0.4s ease forwards; */
             /* opacity: 0; */
        }
        #transcript p:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        #transcript p strong {
            color: #FFD700; /* Nama speaker Emas */
            margin-right: 5px;
            font-weight: 600;
        }

        /* --- Ikon Feather (sudah ada di JS, kita styling aja) --- */
        .feather {
            width: 22px; /* Sedikit lebih besar */
            height: 22px;
            vertical-align: middle;
            stroke-width: 1.8; /* Sedikit lebih tipis */
            /* Warna default ikon di tombol */
             color: #FFD700; /* Emas */
            /* Atau atur via selector tombol spesifik jika perlu warna beda */
            /* #micButton svg { stroke: #FFD700; } */
            transition: transform 0.2s ease;
        }
         #micButton:hover:not(:disabled) .feather {
             transform: scale(1.1); /* Ikon membesar sedikit saat hover */
         }

         /* Animasi Ikon Loader (jika JS menambahkannya) */
         .feather-loader {
             animation: spin 1.5s linear infinite;
         }

         @keyframes spin {
             from { transform: rotate(0deg); }
             to { transform: rotate(360deg); }
         }

    </style>
</head>
<body>

    <!-- === Struktur HTML Tidak Diubah Sama Sekali === -->

    <h1>AI Voice Call (Smart Mic) v2</h1>
    <p style="font-size:0.9em; color:#666; text-align:center; margin-top:-10px; margin-bottom:15px;">(Dengan History Percakapan & Parsing Output)</p> <!-- Style inline ini akan ditimpa oleh CSS di atas -->

    <div class="warning">
        ⚠️ PERINGATAN: API Key ada di dalam kode HTML ini. Jangan bagikan file ini! Hanya untuk penggunaan pribadi.
    </div>

    <div class="container">
        <div class="status-box">
            <strong>Status:</strong> <span id="status">Idle</span>
        </div>

        <div class="io-section">
            <h2>Kamu Bilang:</h2>
            <div id="user-speech" class="speech-bubble user">...</div>
        </div>

        <div class="io-section">
            <h2>AI Bilang:</h2>
            <div id="ai-response" class="speech-bubble ai">...</div>
        </div>

        <div class="controls">
            <button id="micButton" title="Klik untuk mulai/berhenti merekam atau menghentikan AI">
                <!-- Konten button akan diupdate oleh JS -->
            </button>
             <p class="mic-info" id="micInfoText">(Mic nonaktif. Klik tombol untuk memulai)</p>
        </div>

        <div class="transcript-section">
             <h2>Transkrip Percakapan</h2>
             <div id="transcript"></div>
        </div>
    </div>

    <script>
        // --- JavaScript TIDAK DIUBAH SEDIKITPUN ---
        document.addEventListener('DOMContentLoaded', () => {

            const TOGETHER_API_URL = 'https://api.together.xyz/v1/chat/completions';
            const AI_MODEL = 'meta-llama/Llama-3.3-70B-Instruct-Turbo-Free';
            const API_KEYS = [
                 "15b70f2d5532d4056cb40a96dada4f41cd6be5206b3265abaa2bc8c1ce85de1b",
                 "1986fcb80017badcac2c5761e9bc5d9b5b635a57b58573c094c5aaee0f7cad65",
                 "47aacfae02634de54a494b4071c9fb357122f453c3ed25a848e77a32a39c50c2",
                 "11eb49ac44759de26e65730a309d05a82e37a77d3547d94f154bd7a3a66de34d",
                 "cf887a3d000a64a1686d2bb8e392a64b7f46fe131aff4685e5199510106b8608",
                 "9fa71bf023b928a32cad2959fcf5fee36bb9fbb3732ed6ba659892c079da57e0",
                 "401925c1ac6e2e33847169014115e9344dcaf32d1c1fe386c8fc92768d7b15ad",
                 "215c434d7361a2799557f151ab3b3b80c710a09111339e712a82579f8790f7f2",
                 "34211673816c9ef4729e0259c042ebe3d762fb90ff16c36b42ddfb1c0f9e10e6",
                 "1ea461952d729c0e3dccadd919ee5d121a8125bc7bd5924192495528e24e2afb",
                 "40f561d9befc36d117412f9003d81a2306790e536cec5c36ce540833885f6bd5",
                 "f8eb6808a6c585445cd0db8cb5d048b9cb2d35262fe67f9b512ebc17eb4937b2",
                 "f19df6a1c0a9dccb696764e091d8990734acdff7b39f811a873f7ddf580f92ff"
            ];

            function getRandomApiKey() {
                return API_KEYS[Math.floor(Math.random() * API_KEYS.length)];
            }
            // ---------------------------------------------------------------

            // Cek support Web Speech API
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const SpeechSynthesis = window.speechSynthesis;

            if (!SpeechRecognition || !SpeechSynthesis) {
                alert("Maaf, browser lu nggak support Web Speech API. Coba pake Chrome.");
                document.getElementById('micButton').disabled = true;
                document.getElementById('micButton').textContent = 'Browser Error';
                document.getElementById('status').textContent = 'Browser tidak support';
                return;
            }

            // Get Element DOM
            const micButton = document.getElementById('micButton');
            const statusDisplay = document.getElementById('status');
            const userSpeechDisplay = document.getElementById('user-speech');
            const aiResponseDisplay = document.getElementById('ai-response');
            const transcriptDisplay = document.getElementById('transcript');
            const micInfoText = document.getElementById('micInfoText');

            // Ikon SVG
            const micIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
            const stopIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
            const speakerIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            const thinkingIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-loader"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>`;

            // Inisialisasi Speech Recognition (STT)
            const recognition = new SpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.interimResults = true; // Tampilkan hasil sementara
            recognition.continuous = false; // Berhenti otomatis setelah jeda bicara

            // State aplikasi
            let isListening = false;
            let isAISpeaking = false;
            let finalTranscript = '';

            // --- [BARU] History Percakapan ---
            let chatHistory = [
                 // Selalu mulai dengan system prompt
                { role: "system", content: "Kamu adalah asisten AI bernama kartini ai yang realistis ramah dan membantu dalam bahasa indonesia. jangan terlalu kaku seperti ai lainnya, jawab dengan singkat jika memungkinkan." }
            ];
            // --- [AKHIR BARU] ---

            // Fungsi untuk update tampilan tombol
            function updateMicButton(state, text) {
                micButton.disabled = false; // Default enabled
                micButton.classList.remove('listening', 'ai-speaking'); // Hapus class state sebelumnya

                let icon = micIconSVG;
                let buttonText = text || "Mulai Bicara";
                let infoText = "(Klik untuk mulai)";

                switch (state) {
                    case 'listening':
                        isListening = true;
                        icon = stopIconSVG;
                        buttonText = text || "Berhenti Bicara";
                        infoText = "Sedang mendengarkan...";
                        micButton.classList.add('listening');
                        break;
                    case 'processing':
                        icon = thinkingIconSVG; // Gunakan ikon thinking
                        buttonText = text || "Memproses...";
                        infoText = "Sedang mengirim ke AI...";
                        micButton.disabled = true; // Disable saat proses
                        // Class 'processing' tidak ditambahkan scr eksplisit, tapi state disabled + ikon loader bisa di-target CSS
                        break;
                    case 'ai_speaking':
                        isAISpeaking = true;
                        icon = speakerIconSVG;
                        buttonText = text || "AI Berbicara...";
                        infoText = "Klik tombol untuk menghentikan AI";
                        micButton.classList.add('ai-speaking');
                         // Tetap bisa diklik untuk stop AI, jadi jangan disable di sini
                        break;
                    case 'idle':
                    default:
                        isListening = false;
                        isAISpeaking = false;
                        icon = micIconSVG;
                        buttonText = text || "Mulai Bicara";
                        infoText = "(Mic nonaktif. Klik tombol untuk memulai)";
                        break;
                }
                micButton.innerHTML = `${icon} ${buttonText}`;
                micInfoText.textContent = infoText;
            }

            // --- Event Listener untuk Speech Recognition ---
            recognition.onstart = () => {
                console.log('Speech Recognition Dimulai');
                updateMicButton('listening', 'Berhenti Bicara');
                statusDisplay.textContent = 'Mendengarkan...';
                userSpeechDisplay.textContent = '...';
                // aiResponseDisplay.textContent = '...'; // Jangan hapus respon AI sebelumnya
                finalTranscript = '';
                 // Animasi bubble saat mulai (reset)
                userSpeechDisplay.style.opacity = '0';
                setTimeout(() => userSpeechDisplay.style.opacity = '1', 50);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let currentFinal = ''; // Tampung final per event

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcriptPart = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        currentFinal += transcriptPart + ' ';
                    } else {
                        interimTranscript += transcriptPart;
                    }
                }
                 // Gabungkan final dari event ini dengan final sebelumnya
                finalTranscript += currentFinal;
                 const displayTranscript = finalTranscript.trim() || interimTranscript || '...';
                // Tampilkan gabungan final atau interim jika final kosong
                if(userSpeechDisplay.textContent !== displayTranscript) { // Update hanya jika beda
                    userSpeechDisplay.textContent = displayTranscript;
                    // Reset animasi jika perlu (misal saat interim update)
                    userSpeechDisplay.style.opacity = '1'; // Pastikan visible
                }

            };

            recognition.onend = () => {
                console.log('Speech Recognition Selesai.');
                const wasListeningState = isListening; // Simpan state sebelum diubah
                isListening = false; // Set isListening ke false DULU

                if (isAISpeaking) {
                    console.log('Recognition dihentikan karena AI akan/sedang berbicara.');
                     updateMicButton('ai_speaking'); // Pastikan tombol nunjukin AI bicara
                     statusDisplay.textContent = 'AI Berbicara...';
                    return;
                }

                 // Jangan langsung update ke idle, tunggu proses AI jika ada transcript
                 // updateMicButton('idle'); // Dihapus dari sini

                const processedTranscript = finalTranscript.trim(); // Simpan hasil trim
                if (processedTranscript && wasListeningState) {
                    console.log('Final Transcript:', processedTranscript);
                    statusDisplay.textContent = 'Memproses ucapan...';
                    updateMicButton('processing'); // Update ke processing DULU
                    addToTranscript("User", processedTranscript);

                    // Tambah ucapan user ke history SEBELUM kirim ke AI
                    chatHistory.push({ role: "user", content: processedTranscript });
                    console.log("Updated Chat History (User added):", JSON.stringify(chatHistory)); // Log history

                    sendToAI(); // Kirim ke AI, state tombol akan diupdate lagi setelah AI selesai
                } else if (wasListeningState) {
                     statusDisplay.textContent = 'Idle (Tidak ada ucapan terdeteksi)';
                     userSpeechDisplay.textContent = '(Tidak ada ucapan terdeteksi)';
                     updateMicButton('idle'); // Update ke idle jika tidak ada ucapan
                } else {
                    // Ini terjadi jika stop manual tanpa bicara atau stop karena AI
                    if (!isAISpeaking) { // Hanya update ke idle jika bukan karena AI mau bicara
                       statusDisplay.textContent = 'Idle';
                       updateMicButton('idle');
                    }
                }
                // Reset final transcript untuk sesi berikutnya
                finalTranscript = '';
            };

            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error);
                isListening = false; // Pastikan state benar
                 let errorMessage = 'Error Mic: ' + event.error;
                 if (event.error === 'no-speech') {
                     errorMessage = 'Tidak ada suara terdeteksi. Coba lagi.';
                 } else if (event.error === 'audio-capture') {
                     errorMessage = 'Error: Tidak bisa menangkap audio. Cek mikrofon.';
                 } else if (event.error === 'not-allowed') {
                     errorMessage = 'Error: Izin mikrofon ditolak. Izinkan di setting browser.';
                 }
                statusDisplay.textContent = errorMessage;
                userSpeechDisplay.textContent = '...';
                updateMicButton('idle', 'Error Mic'); // Update tombol ke idle dgn pesan error
            };

            // --- Fungsi Parsing Output AI ---
            function parseAIOutput(text) {
                 const cleanedText = text.replace(/[*~`:/|\\]/g, '');
                 return cleanedText.trim();
            }

            // --- Fungsi untuk Text-to-Speech (TTS) ---
            function speak(text) {
                if (SpeechSynthesis.speaking) {
                    console.warn('SpeechSynthesis.speaking - Canceling previous utterance');
                    SpeechSynthesis.cancel();
                     // Jika sedang cancel, AI state mungkin perlu direset manual jika onend tidak terpicu
                     if(isAISpeaking) {
                         isAISpeaking = false;
                         // Mungkin perlu panggil updateMicButton('idle') atau state selanjutnya di sini
                         // tergantung flow yang diinginkan setelah cancel manual
                     }
                }

                const displayText = text; // text yg diterima sudah diparsing
                aiResponseDisplay.textContent = displayText;
                addToTranscript("AI", displayText);
                 // Animasi bubble AI
                 aiResponseDisplay.style.opacity = '0';
                 setTimeout(() => aiResponseDisplay.style.opacity = '1', 50);


                const utterance = new SpeechSynthesisUtterance(displayText); // Ucapkan teks yg sudah bersih
                utterance.lang = 'id-ID';
                utterance.pitch = 1.1;
                utterance.rate = 1.2;

                 // Coba cari suara Google Bahasa Indonesia jika ada
                const voices = SpeechSynthesis.getVoices();
                const indoVoice = voices.find(voice => voice.lang === 'id-ID' && voice.name.includes('Google'));
                if (indoVoice) {
                    utterance.voice = indoVoice;
                    console.log("Menggunakan suara:", indoVoice.name);
                } else {
                     console.log("Suara Google id-ID tidak ditemukan, pakai default.");
                }


                utterance.onstart = () => {
                    console.log('--- AI Mulai Bicara ---');
                    isAISpeaking = true;
                    statusDisplay.textContent = 'AI Berbicara...';
                    updateMicButton('ai_speaking');

                    if (isListening) {
                        console.log('AI mulai bicara, menghentikan user recognition...');
                        recognition.stop(); // Recognition akan memanggil onend, yang akan cek isAISpeaking
                    }
                };

                utterance.onend = () => {
                    console.log('--- AI Selesai Bicara ---');
                    const wasAISpeaking = isAISpeaking; // Cek apakah memang benar2 selesai, bukan karena di-cancel
                    isAISpeaking = false;

                     if(wasAISpeaking){ // Hanya lanjut jika selesai secara normal
                         statusDisplay.textContent = 'Giliran Anda (Mic Otomatis Aktif)';
                         updateMicButton('idle', 'Mic Siap'); // Tombol kembali normal

                        console.log('AI selesai, otomatis aktifkan mic...');
                        // Beri jeda sedikit sebelum mulai mic lagi
                        setTimeout(() => {
                            if (!isListening && !isAISpeaking) { // Cek lagi state sebelum start
                                try {
                                    // Minta izin lagi secara halus jika diperlukan (beberapa browser butuh interaksi baru)
                                    navigator.mediaDevices.getUserMedia({ audio: true })
                                        .then(() => recognition.start())
                                        .catch(err => {
                                            console.error("Gagal dapat izin mic otomatis:", err);
                                            statusDisplay.textContent = "Izinkan mic untuk lanjut.";
                                            updateMicButton('idle', 'Butuh Izin Mic');
                                        });
                                } catch (e) {
                                    console.error("Gagal start recognition otomatis:", e);
                                    statusDisplay.textContent = "Gagal aktifkan mic otomatis.";
                                    updateMicButton('idle', 'Mulai Bicara');
                                }
                            } else {
                                console.log('Mic sudah aktif atau AI bicara lagi, tidak perlu start otomatis.');
                            }
                        }, 500); // Jeda 500ms
                    } else {
                         console.log("onend dipanggil setelah cancel/error, tidak lanjut otomatis.");
                          // Jika di-cancel manual, tombol mungkin sdh dihandle oleh click listener
                         // Jika error, on error yg handle
                         // Jika tidak ada kondisi lain, set ke idle
                         if (!isListening) { // Pastikan user tidak sedang mulai bicara
                              updateMicButton('idle');
                              statusDisplay.textContent = 'Idle';
                         }
                    }
                };

                utterance.onerror = (event) => {
                    console.error('SpeechSynthesis Error:', event.error);
                     const wasAISpeaking = isAISpeaking;
                    isAISpeaking = false;
                    statusDisplay.textContent = 'Error saat AI bicara.';
                    aiResponseDisplay.textContent += " (Gagal bicara)";
                    updateMicButton('idle', 'Error AI Speech');
                    // Jika error terjadi saat AI bicara, mungkin kita tidak mau otomatis mic on
                    // Biarkan user klik manual
                };

                // Panggil speak setelah memastikan voices sudah dimuat (jika perlu)
                 if (SpeechSynthesis.getVoices().length === 0) {
                     SpeechSynthesis.onvoiceschanged = () => {
                         const voices = SpeechSynthesis.getVoices();
                         const indoVoice = voices.find(voice => voice.lang === 'id-ID' && voice.name.includes('Google'));
                         if (indoVoice) utterance.voice = indoVoice;
                         SpeechSynthesis.speak(utterance);
                     };
                 } else {
                     SpeechSynthesis.speak(utterance);
                 }
            }

            // --- Fungsi untuk Mengirim Teks ke Together AI ---
            async function sendToAI() {
                // State sudah di set 'processing' sebelum fungsi ini dipanggil
                aiResponseDisplay.style.opacity = '0'; // Sembunyikan bubble AI lama
                aiResponseDisplay.textContent = '...'; // Reset teks

                const apiKey = getRandomApiKey();
                if (!apiKey) {
                    statusDisplay.textContent = 'Error: API Key tidak tersedia!';
                    updateMicButton('idle', 'Error API Key');
                     aiResponseDisplay.textContent = 'Error Konfigurasi';
                     aiResponseDisplay.style.opacity = '1';
                    return;
                }

                const maxHistoryLength = 11; // 1 system + 5 pasang user/ai
                const currentHistory = chatHistory.length <= maxHistoryLength
                    ? [...chatHistory]
                    : [chatHistory[0], ...chatHistory.slice(-maxHistoryLength + 1)];

                const payload = {
                    model: AI_MODEL,
                    messages: currentHistory,
                    max_tokens: 250,
                    temperature: 0.4,
                    top_p: 0.9,
                    frequency_penalty: 0.5,
                    presence_penalty: 0.2,
                };

                console.log("Mengirim request ke Together AI dengan history:", JSON.stringify(payload, null, 2));

                try {
                    const response = await fetch(TOGETHER_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    console.log(`Status Response Together AI: ${response.status} ${response.statusText}`);

                    if (!response.ok) {
                        let errorBody = "Unknown error";
                        try {
                            errorBody = await response.text();
                            console.error("Error Body dari Together AI:", errorBody);
                        } catch (e) { /* ignore */ }
                        throw new Error(`API error ${response.status}: ${response.statusText}. Detail: ${errorBody}`);
                    }

                    const data = await response.json();
                    console.log("Response JSON dari Together AI diterima.");

                    if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                        const rawAiReply = data.choices[0].message.content.trim();
                        console.log("Jawaban AI (Mentah):", rawAiReply);

                        const cleanedAiReply = parseAIOutput(rawAiReply);
                        console.log("Jawaban AI (Bersih):", cleanedAiReply);

                        chatHistory.push({ role: "assistant", content: cleanedAiReply });
                        console.log("Updated Chat History (AI added):", JSON.stringify(chatHistory));

                        speak(cleanedAiReply); // speak() akan handle update UI & state tombol ke ai_speaking

                    } else {
                        console.error("Struktur response Together AI tidak sesuai:", data);
                        throw new Error("Format response AI tidak dikenali.");
                    }

                } catch (error) {
                    console.error('Error fetching AI response:', error);
                    statusDisplay.textContent = 'Error koneksi ke AI.';
                    aiResponseDisplay.textContent = `Gagal menghubungi AI: ${error.message}`;
                     aiResponseDisplay.style.opacity = '1'; // Tampilkan pesan error
                    updateMicButton('idle', 'Error Koneksi AI');

                    if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                        chatHistory.pop();
                        console.log("AI Error: Pesan user terakhir dihapus dari history.");
                    }
                }
            }

            // --- Fungsi Tambah ke Transkrip ---
            function addToTranscript(speaker, text) {
                const p = document.createElement('p');
                 // Gunakan innerHTML agar bisa render <strong>
                p.innerHTML = `<strong>${speaker}:</strong> ${text}`;
                 // Terapkan animasi fade-in sederhana via JS jika CSS sulit
                p.style.opacity = '0';
                p.style.transition = 'opacity 0.5s ease';
                transcriptDisplay.appendChild(p);
                 // Trigger reflow untuk animasi
                setTimeout(() => p.style.opacity = '1', 10);
                transcriptDisplay.scrollTop = transcriptDisplay.scrollHeight; // Auto scroll
            }

            // --- Event Listener untuk Tombol Mic ---
            micButton.addEventListener('click', () => {
                 console.log(`Tombol diklik. Status: isListening=${isListening}, isAISpeaking=${isAISpeaking}`);

                 if (isAISpeaking) {
                    console.log('User menghentikan AI...');
                    SpeechSynthesis.cancel(); // Ini akan memicu utterance.onend (dengan state isAISpeaking = false)
                    // Update UI mungkin lebih baik ditangani di onend agar konsisten
                    // updateMicButton('idle'); // Mungkin terlalu cepat, biarkan onend handle
                    // statusDisplay.textContent = 'Idle (AI dihentikan)';
                 } else if (isListening) {
                    console.log('User menghentikan rekaman...');
                    recognition.stop(); // Ini akan memicu recognition.onend
                    // onend akan cek apakah ada transcript, jika tidak baru set ke idle
                 } else {
                    console.log('User memulai rekaman...');
                    // Cek izin dulu sebelum start
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(() => {
                            console.log("Izin mic OK, memulai recognition...");
                             try {
                                 // Pastikan tidak ada TTS yang pending/aktif
                                 if (SpeechSynthesis.speaking) {
                                     SpeechSynthesis.cancel();
                                 }
                                 recognition.start(); // recognition.onstart akan handle update UI
                             } catch (e) {
                                 console.error("Gagal start recognition:", e);
                                 statusDisplay.textContent = "Gagal memulai rekaman.";
                                 updateMicButton('idle', 'Error Start');
                             }
                        })
                        .catch(err => {
                            console.error("Error meminta izin mic:", err);
                            statusDisplay.textContent = 'Error: Izin mikrofon ditolak/diperlukan.';
                            alert("Anda perlu mengizinkan akses mikrofon di browser untuk menggunakan fitur ini.");
                            updateMicButton('idle', 'Butuh Izin Mic');
                        });
                }
            });

            // --- Inisialisasi Awal ---
             // Panggil updateMicButton di awal untuk set ikon dan teks default
            updateMicButton('idle');
            statusDisplay.textContent = 'Siap';
             // Set opacity 0 awal untuk animasi fade in bubble
             userSpeechDisplay.style.opacity = '1'; // Atau '0' jika ingin fade in saat pertama kali bicara
             aiResponseDisplay.style.opacity = '1'; // // Atau '0' jika ingin fade in saat AI pertama kali bicara
            userSpeechDisplay.textContent = '...';
            aiResponseDisplay.textContent = '...';

             // Pre-load voices agar lebih siap saat pertama kali bicara
             SpeechSynthesis.getVoices();
             if (SpeechSynthesis.onvoiceschanged !== undefined) {
                 SpeechSynthesis.onvoiceschanged = () => {
                     console.log("Voices loaded:", SpeechSynthesis.getVoices().length);
                 };
             }


            console.log("Aplikasi Voice Call Standalone (Smart Mic) v2 Siap.");
             if (API_KEYS.length === 0) {
                 console.warn("PERINGATAN: List API Key kosong!");
                 statusDisplay.textContent = 'Error: API Key kosong!';
                 updateMicButton('idle', 'Error API Key');
                 micButton.disabled = true;
             } else {
                  console.warn("PERINGATAN KEAMANAN: API Key terlihat di kode sumber!");
             }
             // addToTranscript("System", chatHistory[0].content); // Opsional
        });
    </script>

</body>
</html>
