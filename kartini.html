<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Chat (Face Detection Trigger - Fixed)</title>

    <style>
        /* --- CSS (Sama seperti sebelumnya) --- */
        body { font-family: sans-serif; line-height: 1.6; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 700px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #555; }
        .video-container { position: relative; margin-bottom: 15px; text-align: center; background-color: #eee; padding: 10px; border-radius: 5px; min-height: 260px; /* Ensure space */}
        #webcamVideo { border: 1px solid #ccc; display: block; margin: 0 auto; background-color: #333; /* Dark bg while loading */ }
        #overlayCanvas { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); pointer-events: none; }
        .status-area { text-align: center; margin-bottom: 20px; padding: 10px; background-color: #e9e9e9; border-radius: 5px; }
        #status { font-weight: bold; display: inline-block; min-width: 150px; text-align: left; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 0.9em; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        .text-display { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .text-display h2 { font-size: 1.1em; color: #666; margin-bottom: 5px; }
        .text-display p { background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; min-height: 40px; border-radius: 4px; white-space: pre-wrap; }
        .warning { color: red; font-weight: bold; text-align: center; margin-bottom: 10px; }
    </style>

    <!-- **** WAJIB: Sertakan face-api.js **** -->
    <script defer src="face-api.min.js"></script>

</head>
<body>
    <h1>Ngobrol sama AI (Deteksi Wajah)</h1>
    <p class="warning">Fitur deteksi wajah otomatis bersifat eksperimental! Buka Console (F12) untuk log.</p>

    <div class="container">
        <div class="video-container">
            <video id="webcamVideo" width="320" height="240" autoplay muted playsinline></video>
            <canvas id="overlayCanvas" width="320" height="240"></canvas>
        </div>

        <div class="status-area">
            <p>Status: <span id="status">Initializing...</span></p>
            <button id="manualStartButton" disabled>Mulai Bicara (Manual)</button>
            <button id="manualStopButton" disabled>Berhenti Bicara (Manual)</button>
        </div>

        <div class="text-display">
            <h2>Transkrip Kamu:</h2>
            <p id="user-text">...</p>
            <h2>Respon AI:</h2>
            <p id="ai-text">...</p>
        </div>
    </div>

    <script>
        // --- JavaScript Starts Here ---

        // --- Konfigurasi ---
        let API_KEY;
        const TOGETHER_AI_MODEL = "meta-llama/Llama-3-70B-Instruct-Turbo";
        const TOGETHER_AI_URL = "https://api.together.xyz/v1/chat/completions";

        // --- Referensi Elemen DOM ---
        const statusDisplay = document.getElementById('status');
        const userTextDisplay = document.getElementById('user-text');
        const aiTextDisplay = document.getElementById('ai-text');
        const manualStartButton = document.getElementById('manualStartButton');
        const manualStopButton = document.getElementById('manualStopButton');
        const videoElement = document.getElementById('webcamVideo');
        const canvasElement = document.getElementById('overlayCanvas');

        // --- State Aplikasi ---
        let isListening = false;
        let isSpeakingAI = false;
        let isProcessing = false;
        let finalTranscript = '';
        let recognition;
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;
        let faceApiReady = false;
        let detectionInterval;

        // --- State Deteksi Wajah ---
        let mouthOpenThreshold = 10; // *** TUNING DIPERLUKAN *** Coba turunkan sedikit
        let headMovementThreshold = 5; // *** TUNING DIPERLUKAN ***
        let lastMouthState = 'closed';
        let mouthMovementStart = null;
        let headStillStart = null;
        let mouthStillStart = null;
        let lastHeadPosition = null;
        let faceDetectedConfidence = 0.6; // *** TUNING DIPERLUKAN *** Turunkan sedikit jika deteksi kurang sensitif

        // --- Konfigurasi Waktu Trigger (dalam milidetik) ---
        const MOUTH_MOVEMENT_CONFIRM_DURATION = 300;
        const HEAD_STILL_CONFIRM_DURATION = 1000;
        const MOUTH_STILL_CONFIRM_DURATION = 1200;
        const DETECTION_INTERVAL_MS = 100; // Frekuensi deteksi

        // --- Fungsi API Key & Inisialisasi Dasar ---
        async function getApiKey() {
             try {
                const response = await fetch('/api/getApiKey');
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (!data.apiKey) throw new Error('Invalid API key response format.');
                API_KEY = data.apiKey;
                console.log('API Key fetched successfully.');
            } catch (error) {
                console.error('Failed to fetch API Key:', error);
                statusDisplay.textContent = 'Error: Failed to fetch API Key!';
                alert(`Cannot fetch configuration from server: ${error.message}. AI features will not work.`);
                 manualStartButton.disabled = true;
                 manualStopButton.disabled = true;
            }
        }

        // --- Inisialisasi Web Speech API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
             statusDisplay.textContent = 'Error: Browser no support STT.';
             alert('Maaf, browser kamu tidak mendukung Web Speech API untuk Speech-to-Text.');
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'id-ID';

            recognition.onstart = () => {
                console.log("STT started.");
                isListening = true;
                updateStatusDisplay();
                updateManualButtonStates();
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                userTextDisplay.textContent = finalTranscript + interimTranscript;
                // Timeout hening tidak dipakai, diganti deteksi wajah
            };

            recognition.onend = () => {
                console.log("STT ended.");
                isListening = false;
                updateStatusDisplay();
                updateManualButtonStates();
            };

            recognition.onerror = (event) => {
                console.error('STT Error:', event.error);
                isListening = false; // Pastikan state reset jika error
                 statusDisplay.textContent = `Error STT: ${event.error}`;
                 updateStatusDisplay(); // Update status
                 updateManualButtonStates();
            };
        }

        if (!synthesis) {
            if (SpeechRecognition) statusDisplay.textContent = 'Warning: Browser no support TTS.';
            alert('Maaf, browser kamu tidak mendukung Web Speech API untuk Text-to-Speech. Respon AI hanya teks.');
        }

        // --- Fungsi Inti STT, AI, TTS (Sama) ---
        function startListening() {
            if (!API_KEY || !recognition || !faceApiReady) {
                console.error("Cannot start listening: Prerequisites not met.", { API_KEY, recognition, faceApiReady });
                return;
            }
            if (isListening || isProcessing || isSpeakingAI) return;

            console.log("Attempting to start listening (triggered)...");
            finalTranscript = '';
            userTextDisplay.textContent = '...';
            aiTextDisplay.textContent = '...';
            try {
                recognition.start();
                // onstart akan update UI
            } catch (e) {
                 if (e.name === 'NotAllowedError' || e.message.includes('permission')) {
                     alert("Microphone permission denied or not granted. Please allow microphone access.");
                     statusDisplay.textContent = 'Error: Mic Permission?';
                 } else {
                    console.error("Error starting recognition:", e);
                    statusDisplay.textContent = 'Error starting STT';
                 }
                 isListening = false; // Reset state jika gagal start
                 updateManualButtonStates();
                 updateStatusDisplay();
            }
        }

        function stopListeningAndProcess() {
            if (!isListening || !recognition) return;
            console.log("Stopping listening and processing (triggered by stillness)...");
             try {
                 recognition.stop(); // Akan memicu onend
             } catch (e) { console.warn("Error stopping recognition:", e); }
            isListening = false;
            isProcessing = true; // Mulai proses
            updateStatusDisplay();
            updateManualButtonStates();

            const textToSend = finalTranscript.trim();
            console.log("Final transcript to send:", textToSend);

            if (textToSend) {
                sendToAI(textToSend); // isProcessing akan dihandle oleh sendToAI/speakAI
            } else {
                console.log("No final transcript to send.");
                isProcessing = false; // Tidak ada yg diproses
                statusDisplay.textContent = 'No speech detected.';
                updateStatusDisplay();
                updateManualButtonStates();
            }
        }

        async function sendToAI(userMessage) {
             if (!API_KEY) {
                 console.error("Cannot send to AI: API Key is missing.");
                 statusDisplay.textContent = 'Error: Missing API Key!';
                 aiTextDisplay.textContent = 'Failed to send: API Key config issue.';
                 isProcessing = false;
                 updateManualButtonStates();
                 updateStatusDisplay();
                 return;
             }

            // State sudah di set Processing oleh stopListeningAndProcess
            statusDisplay.textContent = 'AI Thinking...';
            aiTextDisplay.textContent = '...';
            // updateManualButtonStates(); // Sudah dipanggil di stopListeningAndProcess

             try {
                 const response = await fetch(TOGETHER_AI_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: TOGETHER_AI_MODEL,
                        messages: [{ role: "user", content: userMessage }],
                        max_tokens: 250,
                        temperature: 0.7,
                    })
                 });

                 if (!response.ok) {
                     let errorData;
                     try { errorData = await response.json(); console.error("API Error Response:", errorData); }
                     catch (jsonError) { errorData = { error: { message: response.statusText } }; console.error("Non-JSON error response:", await response.text()); }
                    throw new Error(`API Error ${response.status}: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                console.log("Together AI Response:", data);
                const aiResponseText = data.choices?.[0]?.message?.content?.trim();

                if (aiResponseText) {
                    aiTextDisplay.textContent = aiResponseText;
                    // isProcessing akan dihandle oleh speakAI
                    speakAI(aiResponseText);
                } else {
                    throw new Error("Empty AI response.");
                }

             } catch (error) {
                 console.error('Error fetching AI response:', error);
                 statusDisplay.textContent = `Error API: ${error.message}`;
                 aiTextDisplay.textContent = `Failed to get AI response. ${error.message}`;
                 isProcessing = false; // Error, jadi stop processing
                 updateStatusDisplay();
                 updateManualButtonStates();
             }
        }

        function speakAI(textToSpeak) {
             if (!synthesis || !textToSpeak) {
                 console.warn("TTS not available or text empty. Skipping speech.");
                 isProcessing = false; // Pastikan processing selesai jika TTS skip
                 updateStatusDisplay();
                 updateManualButtonStates();
                 return;
             }

            if (isSpeakingAI || synthesis.speaking) {
                synthesis.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            currentUtterance.lang = 'id-ID';
             try {
                 let voices = synthesis.getVoices();
                 if (voices.length > 0) {
                      const indonesianVoice = voices.find(voice => voice.lang === 'id-ID');
                      if (indonesianVoice) currentUtterance.voice = indonesianVoice;
                 }
             } catch (e) { console.error("Error getting voices:", e); }

            currentUtterance.onstart = () => {
                console.log("AI Speech started.");
                isSpeakingAI = true;
                isProcessing = false; // Processing selesai, AI mulai bicara
                updateStatusDisplay();
                updateManualButtonStates();
            };

            currentUtterance.onend = () => {
                console.log("AI Speech finished.");
                isSpeakingAI = false;
                currentUtterance = null;
                updateStatusDisplay();
                updateManualButtonStates();
                resetDetectionTimers(); // Reset timer setelah AI selesai
            };

            currentUtterance.onerror = (event) => {
                 console.error('TTS Error:', event.error);
                 statusDisplay.textContent = `Error TTS: ${event.error}`;
                 isSpeakingAI = false;
                 isProcessing = false;
                 currentUtterance = null;
                 updateStatusDisplay();
                 updateManualButtonStates();
            };

            synthesis.speak(currentUtterance);
        }

        function interruptAI() {
            if (isSpeakingAI && synthesis.speaking) {
                console.log("Interrupting AI Speech (triggered by user movement)...");
                synthesis.cancel(); // Akan memicu onend TTS
                setTimeout(() => {
                     if (!isListening && API_KEY && recognition && faceApiReady) {
                         startListening();
                     } else {
                         console.log("Cannot start listening after interrupt, conditions not met.");
                     }
                }, 150);
            }
        }

        // --- Fungsi Baru: Update Status & Tombol ---
        function updateStatusDisplay() {
            let currentStatus = "Unknown";
            if (!API_KEY) currentStatus = "Error: API Key?";
            else if (!faceApiReady) currentStatus = "Loading Face Detection...";
            else if (isProcessing) currentStatus = "Processing...";
            else if (isListening) currentStatus = "Listening...";
            else if (isSpeakingAI) currentStatus = "AI Speaking...";
            else currentStatus = "Ready (Auto)"; // Default siap

            // Tambahkan info tambahan jika error STT/TTS/Mic
            if(statusDisplay.textContent.startsWith("Error")) { // Jangan timpa pesan error penting
                 // currentStatus = statusDisplay.textContent; // Biarkan pesan error
            } else {
                statusDisplay.textContent = currentStatus;
            }
        }

        function updateManualButtonStates() {
             const canStartManually = API_KEY && recognition && faceApiReady && !isListening && !isSpeakingAI && !isProcessing;
             const canStopManually = isListening;

             manualStartButton.disabled = !canStartManually;
             manualStopButton.disabled = !canStopManually;
        }

        // --- **FUNGSI UTAMA: DETEKSI WAJAH & TRIGGER** ---
        async function setupFaceDetection() {
            statusDisplay.textContent = 'Loading models...';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/models');
                console.log("Face-API models loaded.");

                statusDisplay.textContent = 'Requesting camera...';
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 }, audio: false });
                videoElement.srcObject = stream;
                await new Promise((resolve) => { videoElement.onloadedmetadata = resolve; });
                videoElement.play();
                console.log("Webcam stream started.");
                faceApiReady = true;
                statusDisplay.textContent = 'Face detection ready.';

                startDetectionLoop(); // Mulai loop setelah siap

            } catch (err) {
                console.error("Error setting up face detection:", err);
                 faceApiReady = false; // Tandai tidak siap
                if (err.name === 'NotAllowedError') {
                    statusDisplay.textContent = "Error: Camera Denied!";
                    alert("Camera access denied. Please allow camera access for automatic features.");
                } else if (err.message.includes('404') || err.message.includes('fetch')) {
                    statusDisplay.textContent = "Error: Models Load Failed!";
                     alert("Error loading face detection models. Check '/models' folder, files, and ensure page is served via web server.");
                } else if (err.message.includes('tensor')) {
                    statusDisplay.textContent = "Error: Model/Library Mismatch!";
                    alert(`Tensor shape error: ${err.message}. Ensure models match face-api.js version and are not corrupted. Try re-downloading models.`);
                }
                 else {
                     statusDisplay.textContent = "Error: Face Detection Failed!";
                    alert(`Failed to setup face detection: ${err.message}`);
                }
            } finally {
                 // Update UI state di akhir setup (sukses atau gagal)
                 updateStatusDisplay();
                 updateManualButtonStates();
            }
        }

        function startDetectionLoop() {
             if (detectionInterval) clearInterval(detectionInterval);

             detectionInterval = setInterval(async () => {
                 if (!faceApiReady || videoElement.paused || videoElement.ended) return;

                 const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });
                 const detection = await faceapi.detectSingleFace(videoElement, detectionOptions).withFaceLandmarks(true);

                 const displaySize = { width: videoElement.width, height: videoElement.height };
                 canvasElement.getContext('2d').clearRect(0, 0, canvasElement.width, canvasElement.height);
                 if (detection) {
                     const resizedDetection = faceapi.resizeResults(detection, displaySize);
                     faceapi.draw.drawFaceLandmarks(canvasElement, resizedDetection);
                 }

                 // --- Logika Trigger Utama ---
                 // **** PERBAIKAN: Gunakan positions & tambahkan cek ****
                 if (detection && detection.detection.score > faceDetectedConfidence && detection.landmarks && detection.landmarks.positions && detection.landmarks.positions.length >= 68) {
                     const positions = detection.landmarks.positions; // Akses array posisi
                     console.log(`Detection Score: ${detection.detection.score.toFixed(2)}`);

                     const upperLipBottom = positions[62].y; // Point 62
                     const lowerLipTop = positions[66].y;    // Point 66
                     const mouthVerticalDistance = Math.abs(lowerLipTop - upperLipBottom);
                     const currentMouthState = mouthVerticalDistance > mouthOpenThreshold ? 'open' : 'closed';
                     console.log(`Mouth Distance: ${mouthVerticalDistance.toFixed(1)}, State: ${currentMouthState}, Threshold: ${mouthOpenThreshold}`);

                     const currentHeadPosition = { x: positions[30].x, y: positions[30].y }; // Point 30 (ujung hidung)
                     let headMoved = false;
                     if (lastHeadPosition) {
                         const dx = currentHeadPosition.x - lastHeadPosition.x;
                         const dy = currentHeadPosition.y - lastHeadPosition.y;
                         const distance = Math.sqrt(dx*dx + dy*dy);
                         if (distance > headMovementThreshold) headMoved = true;
                         // console.log(`Head Pos: (${currentHeadPosition.x.toFixed(0)}, ${currentHeadPosition.y.toFixed(0)}), Moved: ${headMoved}, Dist: ${distance.toFixed(1)}`);
                     } else {
                         console.log(`Head Pos Initial: (${currentHeadPosition.x.toFixed(0)}, ${currentHeadPosition.y.toFixed(0)})`);
                     }

                     const now = Date.now();

                     // --- Update Timer & State ---
                     if (currentMouthState !== lastMouthState) {
                         if (!mouthMovementStart) {
                             mouthMovementStart = now;
                             console.log(`[TIMER] Mouth Movement Timer STARTED at ${now}`);
                         }
                         mouthStillStart = null;
                         lastMouthState = currentMouthState;
                     } else {
                         if (mouthMovementStart) console.log(`[TIMER] Mouth Movement Timer RESET (State Same)`);
                         mouthMovementStart = null;
                     }

                     if (headMoved) {
                          if(headStillStart) console.log(`[TIMER] Head Still Timer RESET (Moved)`);
                         headStillStart = null;
                     } else {
                         if (!headStillStart) {
                             headStillStart = now;
                              console.log(`[TIMER] Head Still Timer STARTED at ${now}`);
                         }
                     }

                     if (currentMouthState === 'closed') {
                         if (!mouthStillStart) {
                             mouthStillStart = now;
                              console.log(`[TIMER] Mouth Still Timer STARTED at ${now}`);
                         }
                     } else {
                          if(mouthStillStart) console.log(`[TIMER] Mouth Still Timer RESET (Opened)`);
                         mouthStillStart = null;
                     }

                     // --- Logika Pemicu ---
                     console.log(`[CHECK] isListening: ${isListening}, isProcessing: ${isProcessing}, isSpeakingAI: ${isSpeakingAI}`);

                     // 1. Trigger Mulai Bicara / Interupsi
                     if (mouthMovementStart) {
                         const movementDuration = now - mouthMovementStart;
                         console.log(`[CHECK] Mouth Moving Duration: ${movementDuration}ms / ${MOUTH_MOVEMENT_CONFIRM_DURATION}ms`);
                         if (movementDuration >= MOUTH_MOVEMENT_CONFIRM_DURATION) {
                             console.log(`[CONDITION MET] Mouth Movement Duration!`);
                             if (!isListening && !isProcessing && !isSpeakingAI) {
                                 console.log(">>> TRIGGER: Starting STT via Mouth Movement");
                                 startListening();
                                 resetDetectionTimers();
                             } else if (isSpeakingAI) {
                                 console.log(">>> TRIGGER: Interrupting AI via Mouth Movement");
                                 interruptAI(); // Akan start listening setelahnya
                                 resetDetectionTimers();
                             } else {
                                 console.log(`[SKIP TRIGGER] App state not ready (L:${isListening}, P:${isProcessing}, S:${isSpeakingAI})`);
                             }
                             mouthMovementStart = null; // Reset setelah dicek/dipakai
                         }
                     }

                     // 2. Trigger Berhenti Bicara (Stillness)
                     if (isListening) {
                         const headStillTime = headStillStart ? now - headStillStart : 0;
                         const mouthStillTime = mouthStillStart ? now - mouthStillStart : 0;
                         console.log(`[CHECK STILLNESS] Head: ${headStillTime}ms/${HEAD_STILL_CONFIRM_DURATION}ms, Mouth: ${mouthStillTime}ms/${MOUTH_STILL_CONFIRM_DURATION}ms`);
                         if (headStillTime >= HEAD_STILL_CONFIRM_DURATION && mouthStillTime >= MOUTH_STILL_CONFIRM_DURATION) {
                             console.log(">>> TRIGGER: Stopping STT via Stillness");
                             stopListeningAndProcess();
                             resetDetectionTimers();
                         }
                     }

                     lastHeadPosition = currentHeadPosition;

                 } else {
                     // Wajah tidak terdeteksi / confidence rendah / landmarks tidak lengkap
                     if (detection && detection.landmarks && (!detection.landmarks.positions || detection.landmarks.positions.length < 68)) {
                         console.log("Incomplete landmarks detected.");
                     } else if (detection) {
                        console.log(`Face detected but low confidence: ${detection.detection.score.toFixed(2)} < ${faceDetectedConfidence}`);
                     } else {
                        console.log("Face not detected.");
                     }
                     resetDetectionTimers();
                     lastHeadPosition = null;
                     // Optional: Stop listening if face is lost?
                     // if (isListening) { stopListeningAndProcess(); }
                 }

             }, DETECTION_INTERVAL_MS);
         }

        function resetDetectionTimers() {
             console.log("[TIMER] Resetting all detection timers.");
            mouthMovementStart = null;
            headStillStart = null;
            mouthStillStart = null;
        }

        // --- Inisialisasi Aplikasi ---
        async function initializeApp() {
            statusDisplay.textContent = 'Fetching config...';
            manualStartButton.disabled = true;
            manualStopButton.disabled = true;

            await getApiKey(); // Tunggu API key

            if (API_KEY && faceapi) { // Pastikan faceapi sudah di-load
                await setupFaceDetection(); // Tunggu setup face detection
            } else if (!API_KEY) {
                 statusDisplay.textContent = "Initialization failed (API Key).";
            } else {
                 statusDisplay.textContent = "Error: face-api.js not loaded?";
                 alert("Library face-api.js gagal dimuat. Pastikan file ada dan coba refresh.")
            }

            // Update final UI states (dipanggil juga di dalam finally setupFaceDetection)
            updateStatusDisplay();
            updateManualButtonStates();

            console.log("Initialization attempt complete.");

             // Minta izin mic di awal (opsional, tapi bisa bantu debug)
             if (recognition && API_KEY && faceApiReady) {
                 navigator.mediaDevices.getUserMedia({audio: true})
                     .then(stream => {
                         console.log("Initial mic check: Permission granted.");
                         stream.getTracks().forEach(track => track.stop());
                     })
                     .catch(err => {
                         console.warn("Initial mic check: Permission might be needed or denied.", err.name);
                         if(err.name === 'NotAllowedError') {
                             statusDisplay.textContent = "Error: Mic Denied";
                             alert("Microphone access denied. Auto start will fail. Manual start might prompt again.");
                         }
                     });
             }
        }

        // --- Event Listener untuk Tombol Manual ---
        manualStartButton.addEventListener('click', () => {
             console.log("Manual start button clicked.");
             if (API_KEY && recognition && faceApiReady && !isListening && !isSpeakingAI && !isProcessing) {
                 startListening();
             } else {
                 console.warn("Cannot start manually, conditions not met.");
                 alert("Cannot start manually. Check status, API key, face detection, and microphone permission.")
             }
        });
        manualStopButton.addEventListener('click', () => {
             console.log("Manual stop button clicked.");
             if (isListening) {
                 stopListeningAndProcess();
             }
        });

        // Jalankan inisialisasi saat DOM siap
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- JavaScript Ends Here ---
    </script>
</body>
</html>
