<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Chat (Together AI) - Fetch API Key</title>

    <style>
        /* --- CSS (Sama seperti sebelumnya) --- */
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 700px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1, h2 {
            text-align: center;
            color: #555;
        }

        .video-container {
            position: relative;
            margin-bottom: 15px;
            text-align: center;
            background-color: #eee;
            padding: 10px;
            border-radius: 5px;
        }

        #webcamVideo {
            border: 1px solid #ccc;
            display: block;
            margin: 0 auto;
        }
        #overlayCanvas {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }


        .status-area {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 5px;
        }

        #status {
            font-weight: bold;
            display: inline-block;
            min-width: 150px;
            text-align: left;
        }

        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 0.9em;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .text-display {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .text-display h2 {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 5px;
        }

        .text-display p {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 40px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        /* --- CSS Ends Here --- */
    </style>

    <!-- Include face-api.js jika ingin mencoba deteksi wajah/mulut -->
    <!-- <script defer src="face-api.min.js"></script> -->
</head>
<body>
    <h1>Ngobrol sama AI (Together AI)</h1>

    <div class="container">
        <div class="video-container">
            <video id="webcamVideo" width="320" height="240" autoplay muted playsinline></video>
            <canvas id="overlayCanvas" width="320" height="240"></canvas>
        </div>

        <div class="status-area">
            <p>Status: <span id="status">Initializing...</span></p>
            <button id="manualStartButton" disabled>Mulai Bicara (Manual)</button>
            <button id="manualStopButton" disabled>Berhenti Bicara (Manual)</button>
        </div>

        <div class="text-display">
            <h2>Transkrip Kamu:</h2>
            <p id="user-text">...</p>
            <h2>Respon AI:</h2>
            <p id="ai-text">...</p>
        </div>
    </div>

    <script>
        // --- JavaScript Starts Here ---

        // --- Konfigurasi ---
        let API_KEY; // Akan diisi oleh getApiKey()
        const TOGETHER_AI_MODEL = "meta-llama/Llama-3-70B-Instruct-Turbo"; // Model Baru
        const TOGETHER_AI_URL = "https://api.together.xyz/v1/chat/completions";

        // Ambang batas (placeholder)
        const SILENCE_THRESHOLD_MS = 2000;
        const MOVEMENT_CONFIRMATION_MS = 500;
        const STILLNESS_CONFIRMATION_MS = 1500;

        // --- Referensi Elemen DOM ---
        const statusDisplay = document.getElementById('status');
        const userTextDisplay = document.getElementById('user-text');
        const aiTextDisplay = document.getElementById('ai-text');
        const manualStartButton = document.getElementById('manualStartButton');
        const manualStopButton = document.getElementById('manualStopButton');
        const videoElement = document.getElementById('webcamVideo');

        // --- State Aplikasi ---
        let isListening = false;
        let isSpeakingAI = false;
        let isProcessing = false;
        let finalTranscript = '';
        let silenceTimeout;
        let recognition;
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;

        // --- Fungsi untuk Mengambil API Key dari Backend ---
        async function getApiKey() {
            try {
                const response = await fetch('/api/getApiKey'); // Panggil endpoint backend kamu
                 if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                 }
                const data = await response.json();
                if (!data.apiKey) {
                    throw new Error('Format respons API key tidak valid.');
                }
                API_KEY = data.apiKey; // Simpan API key
                console.log('API Key berhasil diambil.');
                statusDisplay.textContent = 'Ready (Manual)'; // Update status setelah key didapat
                // Aktifkan tombol start jika STT didukung & mic diizinkan
                if (recognition) {
                    checkMicPermissionAndEnableStart();
                }
            } catch (error) {
                console.error('Gagal ambil API Key:', error);
                statusDisplay.textContent = 'Error: Gagal ambil API Key!';
                alert(`Tidak bisa mengambil konfigurasi dari server: ${error.message}. Fitur AI tidak akan berfungsi.`);
                // Tombol start tetap disabled
            }
        }

        // --- Inisialisasi Web Speech API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            statusDisplay.textContent = 'Error: Browser tidak support STT.';
            alert('Maaf, browser kamu tidak mendukung Web Speech API untuk Speech-to-Text.');
            // Tidak perlu disable tombol disini, karena akan dicek setelah API Key & Mic
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'id-ID';

            recognition.onstart = () => {
                console.log("STT started.");
                isListening = true;
                statusDisplay.textContent = 'Mendengarkan...';
                manualStartButton.disabled = true;
                manualStopButton.disabled = false;
                clearTimeout(silenceTimeout);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                userTextDisplay.textContent = finalTranscript + interimTranscript;

                clearTimeout(silenceTimeout);
                if (finalTranscript.trim()) {
                    silenceTimeout = setTimeout(() => {
                        console.log("Silence detected (timeout). Stopping.");
                        if (isListening) {
                            stopListeningAndProcess();
                        }
                    }, SILENCE_THRESHOLD_MS);
                }
                // --- Placeholder Interupsi ---
                // if (isSpeakingAI && detectUserSpeaking()) { interruptAI(); }
            };

            recognition.onend = () => {
                console.log("STT ended.");
                isListening = false;
                 // Hanya enable start jika API key sudah ada
                if (API_KEY) {
                     manualStartButton.disabled = false;
                 }
                manualStopButton.disabled = true;
                clearTimeout(silenceTimeout);
                if (!isProcessing && !isSpeakingAI) {
                    statusDisplay.textContent = API_KEY ? 'Ready (Manual)' : 'Error: API Key?';
                }
            };

            recognition.onerror = (event) => {
                console.error('STT Error:', event.error);
                statusDisplay.textContent = `Error STT: ${event.error}`;
                isListening = false;
                 if (API_KEY) { // Hanya enable start jika API key OK
                    manualStartButton.disabled = false;
                 }
                manualStopButton.disabled = true;
                clearTimeout(silenceTimeout);
            };
        }

        if (!synthesis) {
            // Status sudah diatur oleh STT check jika keduanya error
            if (SpeechRecognition) statusDisplay.textContent = 'Warning: Browser tidak support TTS.';
            alert('Maaf, browser kamu tidak mendukung Web Speech API untuk Text-to-Speech. Respon AI hanya akan berupa teks.');
        }

        // --- Fungsi Inti (Sebagian Besar Sama) ---

        function startListening() {
            // Cek API Key DULU
            if (!API_KEY) {
                alert("API Key belum siap atau gagal diambil dari server. Coba refresh halaman.");
                console.error("Attempted to start listening without API Key.");
                return;
            }
             if (!recognition) {
                alert("Speech Recognition tidak tersedia di browser ini.");
                return;
             }
            if (isListening || isProcessing || isSpeakingAI) return;

            console.log("Attempting to start listening...");
            finalTranscript = '';
            userTextDisplay.textContent = '...';
            aiTextDisplay.textContent = '...';
            try {
                recognition.start();
            } catch (e) {
                 // Tangani error jika user belum kasih izin mic
                 if (e.name === 'NotAllowedError' || e.message.includes('permission')) {
                     alert("Izin mikrofon ditolak atau belum diberikan. Mohon izinkan akses mikrofon.");
                     statusDisplay.textContent = 'Error: Izin Mikrofon?';
                     manualStartButton.disabled = false; // Biarkan user coba lagi
                 } else {
                     console.error("Error starting recognition:", e);
                     statusDisplay.textContent = 'Error mulai STT';
                 }
                 // Reset state jika gagal start
                 isListening = false;
                 manualStartButton.disabled = false;
                 manualStopButton.disabled = true;
            }
        }

        function stopListeningAndProcess() {
            if (!isListening || !recognition) return;

            console.log("Stopping listening and processing...");
             try {
                 recognition.stop();
             } catch (e) { console.warn("Error stopping recognition:", e); }
            isListening = false;
            statusDisplay.textContent = 'Memproses...';
            isProcessing = true;
            manualStopButton.disabled = true; // Tombol stop di-disable saat proses
             // Tombol start juga disable saat proses
             manualStartButton.disabled = true;
            clearTimeout(silenceTimeout);

            const textToSend = finalTranscript.trim();
            console.log("Final transcript to send:", textToSend);

            if (textToSend) {
                sendToAI(textToSend);
            } else {
                console.log("No final transcript.");
                statusDisplay.textContent = API_KEY ? 'Ready (Manual)' : 'Error: API Key?';
                isProcessing = false;
                 if (API_KEY) manualStartButton.disabled = false; // Enable start lagi jika ada API key
            }
        }

        async function sendToAI(userMessage) {
             // Pastikan API_KEY ada sebelum fetch
             if (!API_KEY) {
                 console.error("Cannot send to AI: API Key is missing.");
                 statusDisplay.textContent = 'Error: Missing API Key!';
                 aiTextDisplay.textContent = 'Gagal mengirim: Konfigurasi API Key bermasalah.';
                 isProcessing = false;
                 manualStartButton.disabled = false; // Enable start lagi (meski mungkin tetap error)
                 return;
             }

            statusDisplay.textContent = 'AI Berpikir...';
            aiTextDisplay.textContent = '...';

            try {
                const response = await fetch(TOGETHER_AI_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}` // Gunakan variabel API_KEY
                    },
                    body: JSON.stringify({
                        model: TOGETHER_AI_MODEL, // Gunakan model baru
                        messages: [{ role: "user", content: userMessage }],
                        max_tokens: 250, // Mungkin perlu lebih untuk model 70B
                        temperature: 0.7,
                    }),
                });

                if (!response.ok) {
                     // Coba baca error body dari TogetherAI
                     let errorData;
                     try {
                         errorData = await response.json();
                         console.error("Together AI API Error Response:", errorData);
                     } catch (jsonError) {
                         // Jika response bukan JSON
                         console.error("Non-JSON error response from API:", await response.text());
                         errorData = { error: { message: response.statusText } };
                     }
                    throw new Error(`API Error ${response.status}: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                console.log("Together AI Response:", data);

                const aiResponseText = data.choices?.[0]?.message?.content?.trim();

                if (aiResponseText) {
                    aiTextDisplay.textContent = aiResponseText;
                    speakAI(aiResponseText); // Panggil TTS
                } else {
                    throw new Error("Respon AI kosong atau format tidak sesuai.");
                }

            } catch (error) {
                console.error('Error fetching AI response:', error);
                statusDisplay.textContent = `Error API: ${error.message}`;
                aiTextDisplay.textContent = `Gagal mendapatkan respon AI. ${error.message}`;
                isProcessing = false;
                // Enable start button lagi JIKA API key ada (error mungkin sementara)
                 if (API_KEY) manualStartButton.disabled = false;
            }
            // `finally` block tidak eksplisit, state direset di akhir `speakAI` atau di `catch`
        }

        function speakAI(textToSpeak) {
            if (!synthesis || !textToSpeak) {
                console.warn("TTS not available or text empty. Skipping speech.");
                // Langsung set status Idle setelah AI berpikir selesai & TTS di-skip
                isProcessing = false; // AI process done
                isSpeakingAI = false; // Not speaking
                statusDisplay.textContent = API_KEY ? 'Ready (Manual)' : 'Error: API Key?';
                 if (API_KEY) manualStartButton.disabled = false; // Enable start
                return;
            }

            if (isSpeakingAI || synthesis.speaking) {
                synthesis.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            currentUtterance.lang = 'id-ID';

            // Coba dapatkan suara (best effort)
             try {
                 let voices = synthesis.getVoices();
                 if (voices.length > 0) {
                      const indonesianVoice = voices.find(voice => voice.lang === 'id-ID');
                      if (indonesianVoice) {
                          currentUtterance.voice = indonesianVoice;
                      }
                 } else {
                    // Jika voices kosong, event onvoiceschanged mungkin perlu (tapi bisa kompleks)
                    console.log("Voices array empty initially, using default/waiting for async load.")
                 }
             } catch (e) {
                 console.error("Error getting voices:", e);
             }


            currentUtterance.onstart = () => {
                console.log("AI Speech started.");
                isSpeakingAI = true;
                isProcessing = false; // AI processing finished, TTS starts
                statusDisplay.textContent = 'AI Bicara...';
                manualStartButton.disabled = true; // Disable start while AI speaks
                manualStopButton.disabled = true; // Disable stop too
            };

            currentUtterance.onend = () => {
                console.log("AI Speech finished.");
                isSpeakingAI = false;
                currentUtterance = null;
                statusDisplay.textContent = API_KEY ? 'Ready (Manual)' : 'Error: API Key?';
                if (API_KEY) manualStartButton.disabled = false; // Enable start after AI finishes
            };

            currentUtterance.onerror = (event) => {
                console.error('TTS Error:', event.error);
                statusDisplay.textContent = `Error TTS: ${event.error}`;
                isSpeakingAI = false;
                isProcessing = false;
                currentUtterance = null;
                if (API_KEY) manualStartButton.disabled = false; // Enable start on error too
            };

            synthesis.speak(currentUtterance);
        }

        function interruptAI() {
            if (isSpeakingAI && synthesis.speaking) {
                console.log("Interrupting AI Speech...");
                synthesis.cancel(); // This should trigger onend
                // Wait slightly for state reset in onend, then start listening
                setTimeout(() => {
                     if (!isListening && API_KEY) { // Ensure API key is ready
                         startListening();
                     }
                }, 150); // Slightly longer delay might be safer
            }
        }

        // --- Fungsi Deteksi Gerakan (Placeholder/Konsep - Sama) ---
        async function setupFaceDetection() { /* ... Placeholder ... */ console.log("Placeholder Face Detection Setup");}
        function startDetectionLoop() { /* ... Placeholder ... */ console.log("Placeholder Face Detection Loop");}
        function checkStillnessAndStop() { /* ... Placeholder ... */ }

        // --- Event Listener ---
        manualStartButton.addEventListener('click', startListening);
        manualStopButton.addEventListener('click', stopListeningAndProcess);

        // --- Pengecekan Izin Mikrofon & Enable Tombol Start ---
        function checkMicPermissionAndEnableStart() {
            if (!API_KEY || !recognition) { // Jangan enable jika API key belum ada atau STT tdk support
                manualStartButton.disabled = true;
                return;
            }
            // Cek status izin mikrofon (jika API tersedia)
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'microphone' })
                    .then(permissionStatus => {
                        console.log(`Microphone permission state: ${permissionStatus.state}`);
                        if (permissionStatus.state === 'granted') {
                            manualStartButton.disabled = false;
                             statusDisplay.textContent = 'Ready (Manual)';
                        } else if (permissionStatus.state === 'prompt') {
                            manualStartButton.disabled = false; // User bisa klik untuk trigger prompt
                            statusDisplay.textContent = 'Ready (Need Mic)';
                        } else { // denied
                            manualStartButton.disabled = true;
                             statusDisplay.textContent = 'Error: Mic Denied';
                             alert("Izin mikrofon ditolak. Mohon aktifkan di pengaturan browser.");
                        }
                        permissionStatus.onchange = () => { // Listen for changes
                             console.log(`Microphone permission state changed to: ${permissionStatus.state}`);
                             checkMicPermissionAndEnableStart(); // Re-check logic
                        };
                    })
                    .catch(err => {
                        console.warn("Permission API not fully supported or error:", err);
                        // Fallback: Cukup enable tombolnya, biarkan startListening handle error jika ditolak
                        manualStartButton.disabled = false;
                        statusDisplay.textContent = 'Ready (Manual)';
                    });
            } else {
                console.warn("Permissions API not supported. Enabling button, relying on startListening error handling.");
                // Jika Permissions API tidak didukung, enable saja tombolnya
                 manualStartButton.disabled = false;
                 statusDisplay.textContent = 'Ready (Manual)';
            }
        }


        // --- Inisialisasi Aplikasi ---
        async function initializeApp() {
            statusDisplay.textContent = 'Mengambil Konfigurasi...';
            manualStartButton.disabled = true; // Disable tombol saat init
            manualStopButton.disabled = true;

            // 1. Ambil API Key dulu
            await getApiKey(); // Tunggu sampai API key coba diambil

            // 2. Setup deteksi wajah (jika diimplementasikan)
            // await setupFaceDetection();

            // 3. Cek izin mic dan aktifkan tombol start JIKA API key berhasil diambil & STT didukung
            // Pengecekan mic dipindah ke dalam getApiKey success/atau dipanggil setelahnya
            // Jika getApiKey gagal, tombol tidak akan diaktifkan.
            // Jika getApiKey sukses, checkMicPermissionAndEnableStart akan dipanggil
            if (!API_KEY) {
                console.log("Inisialisasi selesai dengan error pengambilan API Key.");
            } else if (!recognition) {
                 console.log("Inisialisasi selesai, API Key OK, tapi STT tidak didukung.");
                 statusDisplay.textContent = 'Error: STT Not Supported';
            } else {
                 console.log("Inisialisasi dasar selesai. API Key OK, STT OK. Mengecek Mic...");
                 // checkMicPermissionAndEnableStart sudah dipanggil di getApiKey sukses
            }

        }

        // Jalankan inisialisasi saat DOM siap
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- JavaScript Ends Here ---
    </script>
</body>
</html>
