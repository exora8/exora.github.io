<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Chat (Face Detection Trigger)</title>

    <style>
        /* --- CSS (Sama seperti sebelumnya) --- */
        body { font-family: sans-serif; line-height: 1.6; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 700px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #555; }
        .video-container { position: relative; margin-bottom: 15px; text-align: center; background-color: #eee; padding: 10px; border-radius: 5px; min-height: 260px; /* Ensure space */}
        #webcamVideo { border: 1px solid #ccc; display: block; margin: 0 auto; background-color: #333; /* Dark bg while loading */ }
        #overlayCanvas { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); pointer-events: none; }
        .status-area { text-align: center; margin-bottom: 20px; padding: 10px; background-color: #e9e9e9; border-radius: 5px; }
        #status { font-weight: bold; display: inline-block; min-width: 150px; text-align: left; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 0.9em; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        .text-display { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .text-display h2 { font-size: 1.1em; color: #666; margin-bottom: 5px; }
        .text-display p { background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; min-height: 40px; border-radius: 4px; white-space: pre-wrap; }
        .warning { color: red; font-weight: bold; text-align: center; margin-bottom: 10px; }
    </style>

    <!-- **** WAJIB: Sertakan face-api.js **** -->
    <!-- Download dari https://github.com/justadudewhohacks/face-api.js/tree/master/dist -->
    <script defer src="face-api.min.js"></script>

</head>
<body>
    <h1>Ngobrol sama AI (Deteksi Wajah)</h1>
    <p class="warning">Fitur deteksi wajah otomatis bersifat eksperimental!</p>

    <div class="container">
        <div class="video-container">
            <video id="webcamVideo" width="320" height="240" autoplay muted playsinline></video>
            <canvas id="overlayCanvas" width="320" height="240"></canvas>
        </div>

        <div class="status-area">
            <p>Status: <span id="status">Initializing...</span></p>
            <!-- Tombol manual tetap ada sebagai fallback -->
            <button id="manualStartButton" disabled>Mulai Bicara (Manual)</button>
            <button id="manualStopButton" disabled>Berhenti Bicara (Manual)</button>
        </div>

        <div class="text-display">
            <h2>Transkrip Kamu:</h2>
            <p id="user-text">...</p>
            <h2>Respon AI:</h2>
            <p id="ai-text">...</p>
        </div>
    </div>

    <script>
        // --- JavaScript Starts Here ---

        // --- Konfigurasi ---
        let API_KEY;
        const TOGETHER_AI_MODEL = "meta-llama/Llama-3-70B-Instruct-Turbo";
        const TOGETHER_AI_URL = "https://api.together.xyz/v1/chat/completions";

        // --- Referensi Elemen DOM ---
        const statusDisplay = document.getElementById('status');
        const userTextDisplay = document.getElementById('user-text');
        const aiTextDisplay = document.getElementById('ai-text');
        const manualStartButton = document.getElementById('manualStartButton');
        const manualStopButton = document.getElementById('manualStopButton');
        const videoElement = document.getElementById('webcamVideo');
        const canvasElement = document.getElementById('overlayCanvas'); // Canvas untuk overlay

        // --- State Aplikasi ---
        let isListening = false;
        let isSpeakingAI = false;
        let isProcessing = false;
        let finalTranscript = '';
        let silenceTimeout;
        let recognition;
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;
        let faceApiReady = false;
        let detectionInterval; // Untuk menyimpan interval deteksi

        // --- State Deteksi Wajah ---
        let mouthOpenThreshold = 15; // *** TUNING DIPERLUKAN *** (tergantung resolusi, jarak)
        let headMovementThreshold = 5; // *** TUNING DIPERLUKAN *** (pixel)
        let lastMouthState = 'closed'; // 'open' or 'closed'
        let mouthMovementStart = null; // Timestamp
        let headStillStart = null; // Timestamp
        let mouthStillStart = null; // Timestamp
        let lastHeadPosition = null; // { x: number, y: number }
        let faceDetectedConfidence = 0.7; // Minimal confidence untuk deteksi wajah

        // --- Konfigurasi Waktu Trigger (dalam milidetik) ---
        const MOUTH_MOVEMENT_CONFIRM_DURATION = 300;  // Mulut harus bergerak (buka/tutup) selama 0.3s untuk trigger mic/interrupt
        const HEAD_STILL_CONFIRM_DURATION = 1000;    // Kepala harus diam selama 1s
        const MOUTH_STILL_CONFIRM_DURATION = 1200;   // Mulut harus diam (tertutup) selama 1.2s
        const DETECTION_INTERVAL_MS = 100; // Seberapa sering deteksi dijalankan

        // --- Fungsi API Key & Inisialisasi Dasar (Sama seperti sebelumnya) ---
        async function getApiKey() {
            // ... (Kode getApiKey sama persis seperti jawaban sebelumnya) ...
             try {
                const response = await fetch('/api/getApiKey');
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (!data.apiKey) throw new Error('Invalid API key response format.');
                API_KEY = data.apiKey;
                console.log('API Key fetched successfully.');
                // Jangan update status/tombol di sini, tunggu face-api siap
            } catch (error) {
                console.error('Failed to fetch API Key:', error);
                statusDisplay.textContent = 'Error: Failed to fetch API Key!';
                alert(`Cannot fetch configuration from server: ${error.message}. AI features will not work.`);
                // Disable manual buttons if API key fails
                 manualStartButton.disabled = true;
                 manualStopButton.disabled = true;
            }
        }

        // --- Inisialisasi Web Speech API (Sama) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        // ... (Kode inisialisasi SpeechRecognition & Synthesis sama persis) ...
         if (!SpeechRecognition) {
             // ... handle error ...
         } else {
             recognition = new SpeechRecognition();
             // ... setup recognition events (onstart, onresult, onend, onerror) ...
             // PENTING: Di onresult, JANGAN pakai timeout hening lagi, biarkan deteksi wajah yg handle stop
             recognition.onresult = (event) => {
                 let interimTranscript = '';
                 finalTranscript = ''; // Reset final transcript setiap ada hasil baru

                 for (let i = event.resultIndex; i < event.results.length; ++i) {
                     if (event.results[i].isFinal) {
                         finalTranscript += event.results[i][0].transcript;
                     } else {
                         interimTranscript += event.results[i][0].transcript;
                     }
                 }
                 userTextDisplay.textContent = finalTranscript + interimTranscript; // Tampilkan gabungan

                 // Hapus timeout hening, karena kita pakai deteksi wajah/kepala diam
                 // clearTimeout(silenceTimeout);
             };
             recognition.onend = () => {
                 console.log("STT ended.");
                 isListening = false;
                 manualStopButton.disabled = true;
                 // Tombol start manual akan di-enable jika API key & faceAPI siap
                 updateManualButtonStates();
                 if (!isProcessing && !isSpeakingAI) {
                      updateStatusDisplay(); // Update status berdasarkan state saat ini
                 }
             };
             // ... (onstart, onerror sama) ...
         }
         if(!synthesis){ /*...*/ }

        // --- Fungsi Inti STT, AI, TTS (Sama) ---
        function startListening() {
            if (!API_KEY) { console.error("No API Key"); return; }
            if (!recognition) { console.error("No STT support"); return; }
            if (isListening || isProcessing || isSpeakingAI) return; // Sudah aktif

            console.log("Attempting to start listening (triggered)...");
            finalTranscript = '';
            userTextDisplay.textContent = '...';
            aiTextDisplay.textContent = '...';
            try {
                recognition.start();
                // State onstart akan handle UI update
            } catch (e) {
                console.error("Error starting recognition:", e);
                statusDisplay.textContent = 'Error starting STT';
                 updateManualButtonStates(); // Re-enable manual start if possible
            }
        }

        function stopListeningAndProcess() {
            if (!isListening || !recognition) return;
             // Verifikasi tambahan: pastikan kita benar-benar berhenti karena stillness terdeteksi
             // (Ini bisa dihandle di logic trigger)
            console.log("Stopping listening and processing (triggered by stillness)...");
             try {
                 recognition.stop(); // Akan memicu onend
             } catch (e) { console.warn("Error stopping recognition:", e); }
            isListening = false; // Set state eksplisit
            statusDisplay.textContent = 'Processing...';
            isProcessing = true;
             updateManualButtonStates(); // Update tombol saat memproses

            const textToSend = finalTranscript.trim();
            console.log("Final transcript to send:", textToSend);

            if (textToSend) {
                sendToAI(textToSend);
            } else {
                console.log("No final transcript to send.");
                statusDisplay.textContent = 'No speech detected.';
                isProcessing = false;
                updateManualButtonStates(); // Update tombol setelah selesai
                 updateStatusDisplay(); // Update status final
            }
        }

        async function sendToAI(userMessage) {
            // ... (Kode sendToAI sama persis, menggunakan API_KEY dan model baru) ...
             if (!API_KEY) { /* ... handle error ... */ return; }
             statusDisplay.textContent = 'AI Thinking...';
             aiTextDisplay.textContent = '...';
             isProcessing = true; // Pastikan processing state aktif
             updateManualButtonStates();

             try {
                 const response = await fetch(TOGETHER_AI_URL, { /* ... headers, body ... */ });
                 // ... (handle response.ok, parse json) ...
                 const data = await response.json();
                 const aiResponseText = data.choices?.[0]?.message?.content?.trim();
                 if (aiResponseText) {
                     aiTextDisplay.textContent = aiResponseText;
                     // isProcessing akan di-set false oleh speakAI.onstart atau onerror/onend
                     speakAI(aiResponseText);
                 } else { throw new Error("Empty AI response."); }
             } catch (error) {
                 // ... (handle error, update UI) ...
                 isProcessing = false;
                 updateStatusDisplay();
                 updateManualButtonStates();
             }
        }

        function speakAI(textToSpeak) {
            // ... (Kode speakAI sama persis) ...
             if (!synthesis || !textToSpeak) {
                 // ... handle skip TTS ...
                 isProcessing = false; // Pastikan processing selesai jika TTS di-skip
                 updateStatusDisplay();
                 updateManualButtonStates();
                 return;
             }
             // ... (cancel previous, create utterance, find voice) ...
             currentUtterance.onstart = () => {
                 console.log("AI Speech started.");
                 isSpeakingAI = true;
                 isProcessing = false; // Processing selesai, AI mulai bicara
                 updateStatusDisplay();
                 updateManualButtonStates();
             };
             currentUtterance.onend = () => {
                 console.log("AI Speech finished.");
                 isSpeakingAI = false;
                 currentUtterance = null;
                 updateStatusDisplay();
                 updateManualButtonStates();
                 // Mungkin reset state deteksi? Tergantung logic yg diinginkan
                 resetDetectionTimers();
             };
             currentUtterance.onerror = (event) => {
                 // ... (handle error) ...
                 isSpeakingAI = false;
                 isProcessing = false;
                 currentUtterance = null;
                 updateStatusDisplay();
                 updateManualButtonStates();
             };
             synthesis.speak(currentUtterance);
        }

        function interruptAI() {
            if (isSpeakingAI && synthesis.speaking) {
                console.log("Interrupting AI Speech (triggered by user movement)...");
                synthesis.cancel(); // Akan memicu onend TTS
                // Tunggu sebentar agar state TTS (isSpeakingAI) di onend selesai diupdate
                setTimeout(() => {
                     if (!isListening && API_KEY && recognition && faceApiReady) { // Cek semua prasyarat
                         startListening();
                     } else {
                         console.log("Cannot start listening after interrupt, conditions not met.");
                     }
                }, 150); // Jeda singkat
            }
        }

        // --- Fungsi Baru: Update Status & Tombol ---
        function updateStatusDisplay() {
            if (!API_KEY) statusDisplay.textContent = "Error: API Key?";
            else if (!faceApiReady) statusDisplay.textContent = "Loading Face Detection...";
            else if (isProcessing) statusDisplay.textContent = "Processing...";
            else if (isListening) statusDisplay.textContent = "Listening...";
            else if (isSpeakingAI) statusDisplay.textContent = "AI Speaking...";
            else statusDisplay.textContent = "Ready (Auto)"; // Status default jika semua siap
        }

        function updateManualButtonStates() {
             const canStartManually = API_KEY && recognition && faceApiReady && !isListening && !isSpeakingAI && !isProcessing;
             const canStopManually = isListening; // Hanya bisa stop manual jika sedang listening

             manualStartButton.disabled = !canStartManually;
             manualStopButton.disabled = !canStopManually;
        }

        // --- **FUNGSI UTAMA: DETEKSI WAJAH & TRIGGER** ---

        async function setupFaceDetection() {
            statusDisplay.textContent = 'Loading models...';
            try {
                // **** WAJIB: Pastikan path ke model benar ****
                // Download model dari repo face-api.js dan letakkan di folder /models
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/models'); // Pakai Tiny biar lebih ringan
                console.log("Face-API models loaded.");

                // Minta akses kamera SEKARANG
                statusDisplay.textContent = 'Requesting camera...';
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 }, audio: false }); // Minta resolusi spesifik
                videoElement.srcObject = stream;

                // Tunggu video siap dimainkan
                await new Promise((resolve) => { videoElement.onloadedmetadata = resolve; });

                videoElement.play(); // Mainkan video
                console.log("Webcam stream started.");
                faceApiReady = true; // Tandai face-api siap
                statusDisplay.textContent = 'Face detection ready.';
                updateStatusDisplay(); // Update status final
                updateManualButtonStates(); // Aktifkan tombol manual jika kondisi terpenuhi

                // Mulai loop deteksi
                startDetectionLoop();

            } catch (err) {
                console.error("Error setting up face detection:", err);
                statusDisplay.textContent = "Error: Face Detection Failed!";
                if (err.name === 'NotAllowedError') {
                    alert("Camera access denied. Please allow camera access for automatic features.");
                } else if (err.message.includes('404')) {
                     alert("Error loading face detection models. Make sure model files exist in the /models folder and the page is served via a web server.");
                }
                 else {
                    alert(`Failed to setup face detection: ${err.message}`);
                }
                faceApiReady = false;
                 updateManualButtonStates(); // Pastikan tombol disable jika error
            }
        }

        function startDetectionLoop() {
             if (detectionInterval) clearInterval(detectionInterval); // Hapus interval lama jika ada

             detectionInterval = setInterval(async () => {
                 if (!faceApiReady || videoElement.paused || videoElement.ended) {
                     return; // Jangan deteksi jika belum siap atau video tidak jalan
                 }

                 // Opsi deteksi (Tiny lebih cepat)
                 const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 }); // Sesuaikan input size jika perlu

                 // Deteksi wajah + landmarks
                 const detection = await faceapi.detectSingleFace(videoElement, detectionOptions).withFaceLandmarks(true); // true = use Tiny landmarks

                 // --- Gambar Overlay (Opsional) ---
                 const displaySize = { width: videoElement.width, height: videoElement.height };
                 canvasElement.getContext('2d').clearRect(0, 0, canvasElement.width, canvasElement.height);
                 if (detection) {
                     const resizedDetection = faceapi.resizeResults(detection, displaySize);
                     faceapi.draw.drawFaceLandmarks(canvasElement, resizedDetection); // Gambar landmarks
                 }
                 // --- End Overlay ---

                 // --- Logika Trigger Utama ---
                 if (detection && detection.detection.score > faceDetectedConfidence) {
                     const landmarks = detection.landmarks;
                     const mouth = landmarks.getMouth(); // Poin [48..67]

                     // Hitung jarak vertikal bibir (perkiraan)
                     const upperLipBottom = landmarks.getPoint(62).y; // Titik tengah bawah bibir atas
                     const lowerLipTop = landmarks.getPoint(66).y;    // Titik tengah atas bibir bawah
                     const mouthVerticalDistance = Math.abs(lowerLipTop - upperLipBottom);

                     const currentMouthState = mouthVerticalDistance > mouthOpenThreshold ? 'open' : 'closed';

                     // Hitung posisi tengah wajah (untuk deteksi gerakan kepala)
                     const nose = landmarks.getNose(); // Poin [27..35]
                     const currentHeadPosition = { x: nose[3].x, y: nose[3].y }; // Titik ujung hidung

                     let headMoved = false;
                     if (lastHeadPosition) {
                         const dx = currentHeadPosition.x - lastHeadPosition.x;
                         const dy = currentHeadPosition.y - lastHeadPosition.y;
                         const distance = Math.sqrt(dx*dx + dy*dy);
                         if (distance > headMovementThreshold) {
                             headMoved = true;
                         }
                     }

                     // --- Update Timer & State Deteksi ---
                     const now = Date.now();

                     // Mulut Bergerak (Transisi Buka/Tutup)
                     if (currentMouthState !== lastMouthState) {
                         console.log(`Mouth state change: ${lastMouthState} -> ${currentMouthState}`);
                         if (!mouthMovementStart) {
                             mouthMovementStart = now; // Mulai timer gerakan mulut
                         }
                         mouthStillStart = null; // Reset timer mulut diam
                         lastMouthState = currentMouthState;
                     } else {
                         // Mulut tidak berubah state, reset timer gerakan
                         mouthMovementStart = null;
                     }

                     // Kepala Bergerak
                     if (headMoved) {
                         // console.log("Head moved"); // Bisa jadi terlalu berisik
                         headStillStart = null; // Reset timer kepala diam
                     } else {
                         // Kepala Diam
                         if (!headStillStart) {
                             headStillStart = now; // Mulai timer kepala diam
                         }
                     }

                      // Mulut Diam (Tertutup)
                      if (currentMouthState === 'closed') {
                          if (!mouthStillStart) {
                              mouthStillStart = now; // Mulai timer mulut diam
                          }
                      } else {
                          mouthStillStart = null; // Reset jika mulut terbuka
                      }


                     // --- Logika Pemicu (Trigger Logic) ---

                     // 1. Trigger Mulai Bicara / Interupsi AI
                     if (mouthMovementStart && (now - mouthMovementStart >= MOUTH_MOVEMENT_CONFIRM_DURATION)) {
                         if (!isListening && !isProcessing && !isSpeakingAI) {
                             console.log(">>> Mouth movement detected: Starting STT");
                             startListening();
                             resetDetectionTimers(); // Reset timer setelah trigger
                         } else if (isSpeakingAI) {
                             console.log(">>> Mouth movement detected while AI speaking: Interrupting AI");
                             interruptAI(); // Ini akan menghentikan TTS & startListening
                             resetDetectionTimers();
                         }
                          // Reset timer gerakan setelah terpakai
                          mouthMovementStart = null;
                     }

                     // 2. Trigger Berhenti Bicara (Kirim ke AI)
                     if (isListening) { // Hanya cek stillness jika sedang mendengarkan
                          const headStillTime = headStillStart ? now - headStillStart : 0;
                          const mouthStillTime = mouthStillStart ? now - mouthStillStart : 0;

                          if (headStillTime >= HEAD_STILL_CONFIRM_DURATION && mouthStillTime >= MOUTH_STILL_CONFIRM_URATION) {
                              console.log(`>>> Head still for ${headStillTime}ms, Mouth closed/still for ${mouthStillTime}ms: Stopping STT`);
                              stopListeningAndProcess();
                              resetDetectionTimers(); // Reset timer setelah trigger
                          }
                     }

                     // Update posisi kepala terakhir
                     lastHeadPosition = currentHeadPosition;

                 } else {
                     // Wajah tidak terdeteksi / confidence rendah
                     console.log("Face not detected or low confidence.");
                     resetDetectionTimers();
                     lastHeadPosition = null;
                     // Mungkin kita mau stop listening jika wajah hilang? (Opsional)
                     // if (isListening) {
                     //     console.log("Stopping STT because face lost.");
                     //     stopListeningAndProcess();
                     // }
                 }

             }, DETECTION_INTERVAL_MS); // Jalankan deteksi setiap X ms
         }

        function resetDetectionTimers() {
            mouthMovementStart = null;
            headStillStart = null;
            mouthStillStart = null;
            // lastMouthState tidak direset kecuali wajah hilang
            // lastHeadPosition direset jika wajah hilang
        }

        // --- Inisialisasi Aplikasi ---
        async function initializeApp() {
            statusDisplay.textContent = 'Fetching config...';
            manualStartButton.disabled = true;
            manualStopButton.disabled = true;

            // 1. Ambil API Key
            await getApiKey();

            // 2. Jika API Key OK, Setup Face Detection (ini akan minta izin kamera)
            if (API_KEY) {
                await setupFaceDetection(); // Tunggu setup selesai
            } else {
                 statusDisplay.textContent = "Initialization failed (API Key).";
                 // Tombol tetap disable
            }

             // 3. Inisialisasi STT/TTS sudah terjadi di awal script

            // 4. Update final UI states (Tombol & Status)
            updateStatusDisplay();
            updateManualButtonStates();

            console.log("Initialization complete.");
        }

        // --- Event Listener untuk Tombol Manual ---
        manualStartButton.addEventListener('click', () => {
             console.log("Manual start button clicked.");
             // Jika pakai deteksi otomatis, mungkin tombol manual tidak perlu?
             // Atau gunakan ini sebagai override jika otomatis gagal?
             if (faceApiReady && !isListening && !isSpeakingAI && !isProcessing) {
                 startListening();
             } else {
                 console.warn("Cannot start manually, conditions not met or face detection not ready.");
             }
        });
        manualStopButton.addEventListener('click', () => {
             console.log("Manual stop button clicked.");
             if (isListening) {
                 stopListeningAndProcess();
             }
        });


        // Jalankan inisialisasi saat DOM siap
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- JavaScript Ends Here ---
    </script>
</body>
</html>
